<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√úr√ºn Y√∂netim v3.3 - Geli≈ütirilmi≈ü</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo, memo } = React;
    
    // SUPABASE
    const supabase = window.supabase.createClient(
      'https://nfuebvqcfrretrwipnmh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mdWVidnFjZnJyZXRyd2lwbm1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTcyODQsImV4cCI6MjA4MTk5MzI4NH0.hsX6_E3ltS9ovga989lLDOlfU96yE0fG34YVwaudJgU'
    );

    // UTILS
    const formatCurrency = (amount) => `${amount.toFixed(2)} ‚Ç∫`;
    const formatDate = (date) => new Date(date).toLocaleString('tr-TR');

    const smartSort = (results, searchTerm) => {
      const term = searchTerm.toLowerCase().trim();
      if (!term) return results;
      return results.sort((a, b) => {
        let scoreA = 0, scoreB = 0;
        if (a.barcode?.toLowerCase() === term) scoreA += 1000;
        if (b.barcode?.toLowerCase() === term) scoreB += 1000;
        if (a.name.toLowerCase() === term) scoreA += 500;
        if (b.name.toLowerCase() === term) scoreB += 500;
        if (a.current_stock > 0) scoreA += 30;
        if (b.current_stock > 0) scoreB += 30;
        return scoreB - scoreA;
      });
    };

    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    // COMPONENTS
    const LoadingSpinner = memo(() => (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600"></div>
      </div>
    ));

    const Toast = memo(({ message, type = 'success', onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      const colors = { success: 'from-green-500 to-emerald-500', error: 'from-red-500 to-pink-500', warning: 'from-yellow-500 to-orange-500' };

      return (
        <div className={`fixed top-4 right-4 z-50 bg-gradient-to-r ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl`}>
          <div className="flex items-center gap-3">
            <span className="text-2xl">{type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
            <p className="font-semibold">{message}</p>
            <button onClick={onClose} className="ml-4">‚úï</button>
          </div>
        </div>
      );
    });

    // Dolly/El Arabasƒ± ƒ∞konu (Hand Truck) - Resme benzer basit versiyon
    const DollyIcon = ({ size = 48, color = "currentColor" }) => (
      <svg width={size} height={size} viewBox="0 0 100 100" fill={color} xmlns="http://www.w3.org/2000/svg">
        {/* Tekerlek */}
        <circle cx="30" cy="85" r="12" fill="none" stroke={color} strokeWidth="8"/>
        <circle cx="30" cy="85" r="4" fill={color}/>
        {/* Sap */}
        <path d="M30 73 L30 35 L10 15" fill="none" stroke={color} strokeWidth="8" strokeLinecap="round" strokeLinejoin="round"/>
        {/* Platform */}
        <path d="M30 73 L55 73" fill="none" stroke={color} strokeWidth="8" strokeLinecap="round"/>
        {/* Kutular */}
        <rect x="45" y="25" width="30" height="25" rx="3" fill={color}/>
        <rect x="45" y="53" width="30" height="20" rx="3" fill={color}/>
      </svg>
    );

    const StatsCard = memo(({ title, value, gradient, icon }) => (
      <div className={`bg-gradient-to-r ${gradient} text-white rounded-xl p-6 shadow-lg`}>
        <p className="text-sm opacity-80">{title}</p>
        <div className="flex justify-between items-center mt-2">
          <p className="text-3xl font-bold">{value}</p>
          <span className="text-4xl opacity-50">{icon}</span>
        </div>
      </div>
    ));

    const ProductCard = memo(({ product, cart, entryCart, onSelect, onAddToCart, onAddToEntry, onStock, onEdit, onDelete, onTransfer, isSelected }) => {
      const cartItem = cart?.find(c => c.id === product.id);
      const entryItem = entryCart?.find(c => c.id === product.id);
      const availableStock = product.current_stock - (cartItem?.quantity || 0);
      const isLowStock = availableStock <= product.min_stock;
      const isOutOfStock = availableStock <= 0;

      return (
        <div className={`border-2 rounded-xl p-4 hover:shadow-lg ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
          <div className="flex gap-4">
            <input type="checkbox" checked={isSelected} onChange={() => onSelect(product.id)} className="w-5 h-5 mt-1 rounded" />
            
            <div className="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center">
              <span className="text-2xl">üì¶</span>
            </div>
            
            <div className="flex-1">
              <div className="flex justify-between mb-2">
                <div>
                  <h3 className="font-bold text-lg">{product.name}</h3>
                  <div className="flex gap-2 mt-1 flex-wrap">
                    <span className="bg-green-500 text-white text-sm px-3 py-1 rounded-full">{formatCurrency(product.price)}</span>
                    <span className={`text-sm px-3 py-1 rounded-full ${isOutOfStock ? 'bg-red-100 text-red-800' : isLowStock ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                      {availableStock} adet
                    </span>
                    {cartItem && <span className="text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-800">üõí {cartItem.quantity}</span>}
                    {entryItem && <span className="text-sm px-3 py-1 rounded-full bg-teal-100 text-teal-800">üì• +{entryItem.quantity}</span>}
                  </div>
                </div>
                
                <div className="flex gap-2">
                  {onAddToEntry && <button onClick={() => onAddToEntry(product)} title="Hƒ±zlƒ± Stok Giri≈ü" className="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 font-semibold">üì•</button>}
                  <button onClick={() => onAddToCart(product)} disabled={isOutOfStock} title="Sepete Ekle" className={`px-4 py-2 rounded-lg font-semibold ${isOutOfStock ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}`}>üõí</button>
                  <button onClick={() => onStock(product)} title="Stok Giri≈ü/√áƒ±kƒ±≈ü" className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 font-semibold">üì¶</button>
                  {onTransfer && <button onClick={() => onTransfer(product)} title="Depolar Arasƒ± Ta≈üƒ±" className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold">üöö</button>}
                  {onEdit && <button onClick={() => onEdit(product)} title="D√ºzenle" className="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold">‚úèÔ∏è</button>}
                  {onDelete && <button onClick={() => onDelete(product)} title="Stoƒüu Sƒ±fƒ±rla" className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold">üîª</button>}
                </div>
              </div>
              
              <div className="grid grid-cols-3 gap-2 text-sm text-gray-600">
                <div><span className="font-semibold">Barkod:</span> {product.barcode || '-'}</div>
                <div><span className="font-semibold">Depo:</span> {product.depot || '-'}</div>
                <div><span className="font-semibold">Raf:</span> {product.shelf || '-'}</div>
              </div>
            </div>
          </div>
        </div>
      );
    });

    const SearchBar = memo(({ value, onChange, onSearch, onClear, searching }) => (
      <div className="flex gap-2">
        <div className="flex-1 relative">
          <input 
            type="text" 
            placeholder="√úr√ºn adƒ± veya barkod (min 3 karakter)..." 
            value={value} 
            onChange={(e) => onChange(e.target.value)} 
            onKeyDown={(e) => e.key === 'Enter' && value.trim().length >= 3 && onSearch()} 
            className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
          />
          {value && value.trim().length < 3 && value.trim().length > 0 && (
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-orange-500 text-sm">
              {3 - value.trim().length} karakter daha
            </span>
          )}
        </div>
        <button 
          onClick={onSearch} 
          disabled={searching || value.trim().length < 3} 
          className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold disabled:opacity-50"
        >
          {searching ? '‚è≥' : 'üîç'} Ara
        </button>
        {value && <button onClick={onClear} className="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600">‚úï</button>}
      </div>
    ));

    const Pagination = memo(({ currentPage, totalPages, onPageChange, totalItems, itemsPerPage }) => {
      if (totalPages <= 1) return null;
      
      const startItem = (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
      
      const getPageNumbers = () => {
        const pages = [];
        const maxVisible = 5;
        let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(totalPages, start + maxVisible - 1);
        
        if (end - start + 1 < maxVisible) {
          start = Math.max(1, end - maxVisible + 1);
        }
        
        for (let i = start; i <= end; i++) {
          pages.push(i);
        }
        return pages;
      };

      return (
        <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 p-4 bg-gray-50 rounded-xl">
          <div className="text-sm text-gray-600">
            <span className="font-semibold">{totalItems}</span> √ºr√ºnden <span className="font-semibold">{startItem}-{endItem}</span> arasƒ± g√∂steriliyor
          </div>
          
          <div className="flex items-center gap-2">
            <button
              onClick={() => onPageChange(1)}
              disabled={currentPage === 1}
              className="px-3 py-2 rounded-lg bg-white border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ‚èÆÔ∏è
            </button>
            <button
              onClick={() => onPageChange(currentPage - 1)}
              disabled={currentPage === 1}
              className="px-3 py-2 rounded-lg bg-white border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ‚óÄÔ∏è
            </button>
            
            {getPageNumbers().map(page => (
              <button
                key={page}
                onClick={() => onPageChange(page)}
                className={`px-4 py-2 rounded-lg font-semibold ${
                  currentPage === page 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-white border hover:bg-gray-100'
                }`}
              >
                {page}
              </button>
            ))}
            
            <button
              onClick={() => onPageChange(currentPage + 1)}
              disabled={currentPage === totalPages}
              className="px-3 py-2 rounded-lg bg-white border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ‚ñ∂Ô∏è
            </button>
            <button
              onClick={() => onPageChange(totalPages)}
              disabled={currentPage === totalPages}
              className="px-3 py-2 rounded-lg bg-white border hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              ‚è≠Ô∏è
            </button>
          </div>
        </div>
      );
    });

    // MAIN APP
    function App() {
      const [user, setUser] = useState(null);
      const [page, setPage] = useState('home');
      const [loading, setLoading] = useState(false);
      const [products, setProducts] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [categories, setCategories] = useState([]);
      const [sales, setSales] = useState([]);
      const [search, setSearch] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [searching, setSearching] = useState(false);
      const [selectedProducts, setSelectedProducts] = useState([]);
      const [cart, setCart] = useState([]);
      const [discount, setDiscount] = useState(0);
      const [modal, setModal] = useState('');
      const [selected, setSelected] = useState(null);
      const [toast, setToast] = useState(null);
      const [stockMovement, setStockMovement] = useState({ quantity: 0, type: 'in', depot: '', shelf: '' });
      const [depots, setDepots] = useState([]);
      const [productForm, setProductForm] = useState({ name: '', barcode: '', price: 0, min_stock: 10 });

      // DEPO Y√ñNETƒ∞Mƒ∞
      const [depotForm, setDepotForm] = useState({ name: '', location: '', description: '' });
      const [selectedDepot, setSelectedDepot] = useState(null);

      // RAF Y√ñNETƒ∞Mƒ∞
      const [shelves, setShelves] = useState([]);
      const [shelfForm, setShelfForm] = useState({ name: '', depot_id: '', description: '' });
      const [selectedShelf, setSelectedShelf] = useState(null);

      // √úR√úN TA≈ûIMA
      const [transferForm, setTransferForm] = useState({ depot: '', shelf: '', quantity: 0 });
      
      // Fƒ∞LTRELER
      const [depotFilter, setDepotFilter] = useState('all');
      const [showOnlyInStock, setShowOnlyInStock] = useState(true);
      
      // SAYFALAMA
      const [currentPage, setCurrentPage] = useState(1);
      const [totalProducts, setTotalProducts] = useState(0);
      const [itemsPerPage, setItemsPerPage] = useState(25);
      
      // Son satƒ±≈ü bilgisi (yazdƒ±rma i√ßin)
      const [lastSale, setLastSale] = useState(null);
      
      // STOK Gƒ∞Rƒ∞≈û
      const [entryCart, setEntryCart] = useState([]);
      const [entryDepot, setEntryDepot] = useState('');
      const [entryShelf, setEntryShelf] = useState('');

      // AUTH STATE
      const [authMode, setAuthMode] = useState('login'); // 'login' veya 'register'
      const [authForm, setAuthForm] = useState({ email: '', password: '', fullName: '' });
      const [authLoading, setAuthLoading] = useState(false);
      const [initialLoading, setInitialLoading] = useState(true);

      const fileRef = useRef(null);
      const priceFileRef = useRef(null);

      const showToast = useCallback((msg, type = 'success') => setToast({ message: msg, type }), []);

      // Auth fonksiyonlarƒ±
      const handleLogin = async (e) => {
        e.preventDefault();
        if (!authForm.email || !authForm.password) return showToast('Email ve ≈üifre gerekli', 'warning');
        setAuthLoading(true);
        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: authForm.email,
            password: authForm.password
          });
          if (error) throw error;
          showToast('Giri≈ü ba≈üarƒ±lƒ±!', 'success');
        } catch (err) {
          showToast(err.message || 'Giri≈ü hatasƒ±', 'error');
        }
        setAuthLoading(false);
      };

      // Kayƒ±t onay state'i
      const [pendingRegister, setPendingRegister] = useState(null);

      const handleRegister = async (e) => {
        e.preventDefault();
        if (!authForm.email || !authForm.password || !authForm.fullName) return showToast('T√ºm alanlar gerekli', 'warning');
        if (authForm.password.length < 6) return showToast('≈ûifre en az 6 karakter olmalƒ±', 'warning');
        
        // Onay modalƒ±nƒ± g√∂ster
        setPendingRegister({
          email: authForm.email,
          password: authForm.password,
          fullName: authForm.fullName
        });
      };

      const confirmRegister = async () => {
        if (!pendingRegister) return;
        setAuthLoading(true);
        try {
          const { data, error } = await supabase.auth.signUp({
            email: pendingRegister.email,
            password: pendingRegister.password,
            options: {
              data: { full_name: pendingRegister.fullName },
              emailRedirectTo: undefined
            }
          });
          if (error) throw error;
          showToast('‚úÖ Kullanƒ±cƒ± olu≈üturuldu! Giri≈ü yapabilirsiniz.', 'success');
          setAuthMode('login');
          setAuthForm({ email: pendingRegister.email, password: '', fullName: '' });
          setPendingRegister(null);
        } catch (err) {
          showToast(err.message || 'Kayƒ±t hatasƒ±', 'error');
        }
        setAuthLoading(false);
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
        showToast('√áƒ±kƒ±≈ü yapƒ±ldƒ±', 'success');
      };

      // Session kontrol√º
      useEffect(() => {
        const checkSession = async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            setUser({
              id: session.user.id,
              email: session.user.email,
              full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0]
            });
          }
          setInitialLoading(false);
        };
        checkSession();

        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          if (session?.user) {
            setUser({
              id: session.user.id,
              email: session.user.email,
              full_name: session.user.user_metadata?.full_name || session.user.email.split('@')[0]
            });
          } else {
            setUser(null);
          }
        });

        return () => subscription.unsubscribe();
      }, []);

      useEffect(() => {
        if (user) {
          loadData();
        }
      }, [user]);

      useEffect(() => {
        if (user) {
          loadProducts(true);
        }
      }, [user, depotFilter, showOnlyInStock, currentPage, itemsPerPage]);

      const loadData = useCallback(async () => {
        try {
          const [cat, dep, shv, prof] = await Promise.all([
            supabase.from('categories').select('*'),
            supabase.from('depots').select('*'),
            supabase.from('shelves').select('*'),
            supabase.from('profiles').select('*')
          ]);
          setCategories(cat.data || []);
          setDepots(dep.data || []);
          setShelves(shv.data || []);
          
          const profilesMap = {};
          (prof.data || []).forEach(p => { profilesMap[p.id] = p; });
          
          // Satƒ±≈ülarƒ± √ßek
          const { data: salesData, error: salesError } = await supabase
            .from('sales')
            .select('*, sale_items(*, products(*))')
            .order('created_at', { ascending: false })
            .limit(100);
          
          if (salesError) {
            console.error('Satƒ±≈ü y√ºkleme hatasƒ±:', salesError);
          }
          
          // Satƒ±≈ülara profil bilgisi ekle
          const salesWithProfiles = (salesData || []).map(sale => ({
            ...sale,
            profiles: profilesMap[sale.user_id] || null
          }));
          
          setSales(salesWithProfiles);
          
        } catch (err) {
          console.error('Veri y√ºkleme hatasƒ±:', err);
        }
      }, []);

      // √úr√ºnleri y√ºkle (products + inventory birle≈üik)
      const loadProducts = useCallback(async (alsoRefreshSearch = false) => {
        setLoading(true);
        try {
          // T√ºm √ºr√ºnleri √ßek (pagination ile)
          let allProductsData = [];
          let page = 0;
          const pageSize = 1000;
          
          while (true) {
            const { data, error } = await supabase
              .from('products')
              .select('*')
              .order('name')
              .range(page * pageSize, (page + 1) * pageSize - 1);
            
            if (error) {
              console.error('Products hatasƒ±:', error);
              break;
            }
            
            if (!data || data.length === 0) break;
            allProductsData = [...allProductsData, ...data];
            
            if (data.length < pageSize) break; // Son sayfa
            page++;
          }
          
          console.log('üì¶ loadProducts - Products:', allProductsData.length, 'adet');
          
          // T√ºm inventory'yi √ßek (pagination ile)
          let allInventoryData = [];
          page = 0;
          
          while (true) {
            const { data, error } = await supabase
              .from('inventory')
              .select('*')
              .range(page * pageSize, (page + 1) * pageSize - 1);
            
            if (error) {
              console.error('Inventory hatasƒ±:', error);
              break;
            }
            
            if (!data || data.length === 0) break;
            allInventoryData = [...allInventoryData, ...data];
            
            if (data.length < pageSize) break;
            page++;
          }
          
          console.log('üì¶ loadProducts - Inventory:', allInventoryData.length, 'adet');
          
          const productsData = allProductsData;
          const inventoryData = allInventoryData;
          
          // Inventory'yi √ºr√ºnlerle birle≈ütir
          const inventoryWithProducts = (inventoryData || []).map(inv => {
            const product = (productsData || []).find(p => p.id === inv.product_id);
            return {
              ...inv,
              inventory_id: inv.id,
              id: inv.product_id,
              name: product?.name || 'Bilinmeyen √úr√ºn',
              barcode: product?.barcode,
              price: product?.price || 0,
              min_stock: product?.min_stock ?? 10,
              current_stock: inv.quantity,
              depot: inv.depot,
              shelf: inv.shelf
            };
          });
          
          // Inventory'de olmayan √ºr√ºnleri de ekle (stoksuz √ºr√ºnler)
          const productIdsInInventory = new Set((inventoryData || []).map(inv => inv.product_id));
          const productsWithoutInventory = (productsData || [])
            .filter(p => !productIdsInInventory.has(p.id))
            .map(p => ({
              id: p.id,
              name: p.name,
              barcode: p.barcode,
              price: p.price,
              min_stock: p.min_stock ?? 10,
              current_stock: 0,
              depot: null,
              shelf: null
            }));
          
          // T√ºm √ºr√ºnleri birle≈ütir
          let allProducts = [...inventoryWithProducts, ...productsWithoutInventory];
          
          // Depo filtresi
          if (depotFilter !== 'all') {
            allProducts = allProducts.filter(p => p.depot === depotFilter);
          }
          
          // Stok filtresi
          if (showOnlyInStock) {
            allProducts = allProducts.filter(p => p.current_stock > 0);
          }
          
          // ƒ∞sme g√∂re sƒ±rala
          allProducts.sort((a, b) => a.name.localeCompare(b.name));
          
          // Sayfalama
          const total = allProducts.length;
          const from = (currentPage - 1) * itemsPerPage;
          const to = from + itemsPerPage;
          const paged = allProducts.slice(from, to);
          
          setProducts(paged);
          setTotalProducts(total);
          
          // Inventory'yi fiyat bilgisiyle birlikte kaydet (stats i√ßin)
          const inventoryWithPrices = (inventoryData || []).map(inv => {
            const product = (productsData || []).find(p => p.id === inv.product_id);
            return { ...inv, price: product?.price || 0 };
          });
          setInventory(inventoryWithPrices);
          
          // Arama sonu√ßlarƒ±nƒ± g√ºncelle
          if (alsoRefreshSearch && search.trim()) {
            const searchLower = search.toLowerCase();
            const searchFiltered = allProducts.filter(p => 
              p.name?.toLowerCase().includes(searchLower) || 
              p.barcode?.toLowerCase().includes(searchLower)
            );
            setSearchResults(searchFiltered.slice(0, 50));
          }
          
        } catch (err) {
          console.error('√úr√ºn y√ºkleme hatasƒ±:', err);
          showToast('√úr√ºn y√ºkleme hatasƒ±', 'error');
        }
        setLoading(false);
      }, [depotFilter, showOnlyInStock, currentPage, itemsPerPage, search]);

      const performSearch = useCallback(async (term, silent = false) => {
        const searchTerm = term ? term.trim() : '';
        if (!searchTerm || searchTerm.length < 2) {
          if (!silent && searchTerm.length > 0 && searchTerm.length < 2) {
            showToast('En az 2 karakter girin', 'warning');
          }
          setSearchResults([]);
          setSearching(false);
          return;
        }
        setSearching(true);
        try {
          console.log('üîç Arama ba≈üladƒ±:', searchTerm);
          
          // T√ºm DB'den arama (limit yok)
          const { data: productsData, error: prodError } = await supabase
            .from('products')
            .select('*')
            .or(`name.ilike.%${searchTerm}%,barcode.ilike.%${searchTerm}%`)
            .order('name');
          
          if (prodError) {
            console.error('Arama hatasƒ±:', prodError);
            if (!silent) showToast('Arama hatasƒ±', 'error');
            setSearching(false);
            return;
          }
          
          console.log('üì¶ Bulunan √ºr√ºn:', productsData?.length || 0);
          
          // Bu √ºr√ºnlerin inventory bilgilerini √ßek
          const productIds = (productsData || []).map(p => p.id);
          
          let inventoryData = [];
          if (productIds.length > 0) {
            // Batch halinde inventory √ßek (Supabase limiti i√ßin)
            const batchSize = 500;
            for (let i = 0; i < productIds.length; i += batchSize) {
              const batch = productIds.slice(i, i + batchSize);
              const { data: invData } = await supabase
                .from('inventory')
                .select('*')
                .in('product_id', batch);
              if (invData) inventoryData = [...inventoryData, ...invData];
            }
          }
          
          console.log('üì¶ Inventory:', inventoryData.length);
          
          // Inventory'yi √ºr√ºnlerle birle≈ütir
          const inventoryWithProducts = inventoryData.map(inv => {
            const product = (productsData || []).find(p => p.id === inv.product_id);
            return {
              ...inv,
              inventory_id: inv.id,
              id: inv.product_id,
              name: product?.name || 'Bilinmeyen √úr√ºn',
              barcode: product?.barcode,
              price: product?.price || 0,
              min_stock: product?.min_stock ?? 10,
              current_stock: inv.quantity,
              depot: inv.depot,
              shelf: inv.shelf
            };
          });
          
          // Inventory'de olmayan √ºr√ºnleri de ekle (stoksuzlar)
          const productIdsInInventory = new Set(inventoryData.map(inv => inv.product_id));
          const productsWithoutInventory = (productsData || [])
            .filter(p => !productIdsInInventory.has(p.id))
            .map(p => ({
              id: p.id,
              name: p.name,
              barcode: p.barcode,
              price: p.price,
              min_stock: p.min_stock ?? 10,
              current_stock: 0,
              depot: null,
              shelf: null
            }));
          
          const allResults = [...inventoryWithProducts, ...productsWithoutInventory];
          
          console.log('‚úÖ Toplam sonu√ß:', allResults.length);
          
          setSearchResults(allResults);
          if (allResults.length === 0 && !silent) {
            showToast('Sonu√ß bulunamadƒ±', 'warning');
          }
        } catch (err) {
          console.error('Arama hatasƒ±:', err);
          if (!silent) showToast('Arama hatasƒ±', 'error');
          setSearchResults([]);
        }
        setSearching(false);
      }, []);

      // Arama input deƒüi≈ütiƒüinde (min 2 karakter, 500ms bekleme)
      useEffect(() => {
        const timer = setTimeout(() => {
          if (search.trim().length >= 2) {
            performSearch(search, true); // silent mode
          } else if (search.trim().length === 0) {
            setSearchResults([]);
          }
        }, 500);
        return () => clearTimeout(timer);
      }, [search, performSearch]);

      // Arama sonu√ßlarƒ±nƒ± yenile (i≈ülem sonrasƒ± kullanƒ±lƒ±r)
      const refreshSearch = useCallback(async () => {
        if (!search.trim()) return;
        await performSearch(search);
      }, [search]);

      const toggleProductSelection = useCallback((id) => {
        setSelectedProducts(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
      }, []);

      const addToCart = useCallback((product) => {
        setCart(prev => {
          const ex = prev.find(i => i.id === product.id);
          const currentInCart = ex ? ex.quantity : 0;
          
          // Ger√ßek stok kontrol√º (sepetteki miktar dahil)
          if (currentInCart >= product.current_stock) {
            showToast('Yetersiz stok', 'warning');
            return prev;
          }
          
          if (ex) {
            showToast(`${product.name} (${ex.quantity + 1} adet)`, 'success');
            return prev.map(i => i.id === product.id ? { ...i, quantity: i.quantity + 1 } : i);
          }
          showToast(`üõí ${product.name} sepete eklendi`, 'success');
          return [...prev, { ...product, quantity: 1 }];
        });
      }, []);

      const updateCartQty = useCallback((id, qty) => {
        if (qty <= 0) {
          setCart(prev => prev.filter(i => i.id !== id));
        } else {
          setCart(prev => {
            const item = prev.find(i => i.id === id);
            if (item && qty > item.current_stock) {
              showToast(`Yetersiz stok! Mevcut: ${item.current_stock}`, 'warning');
              return prev.map(i => i.id === id ? { ...i, quantity: item.current_stock } : i);
            }
            return prev.map(i => i.id === id ? { ...i, quantity: qty } : i);
          });
        }
      }, []);

      const completeSale = useCallback(async () => {
        if (cart.length === 0) return showToast('Sepet bo≈ü', 'warning');
        
        // Satƒ±≈ü √∂ncesi stok kontrol√º
        const overStockItems = cart.filter(item => item.quantity > item.current_stock);
        if (overStockItems.length > 0) {
          const names = overStockItems.map(i => `${i.name} (istenen: ${i.quantity}, stok: ${i.current_stock})`).join(', ');
          showToast(`Yetersiz stok: ${names}`, 'error');
          return;
        }
        
        try {
          const sub = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
          const tot = sub - (sub * discount / 100);
          
          // Satƒ±≈üƒ± kaydet (demo kullanƒ±cƒ±sƒ± i√ßin user_id null)
          const userId = (user?.id && user.id !== 'demo') ? user.id : null;
          const { data: sale, error: saleError } = await supabase.from('sales').insert({ 
            total_amount: tot, 
            discount_percentage: discount,
            user_id: userId
          }).select().single();
          
          if (saleError) {
            console.error('Satƒ±≈ü kayƒ±t hatasƒ±:', saleError);
            showToast('Satƒ±≈ü kaydedilemedi: ' + saleError.message, 'error');
            return;
          }
          
          // Satƒ±≈ü kalemlerini ve stok g√ºncellemelerini paralel yap
          const saleItemsPromises = cart.map(item => 
            supabase.from('sale_items').insert({ 
              sale_id: sale.id, 
              product_id: item.id, 
              quantity: item.quantity, 
              price: item.price, 
              total: item.price * item.quantity 
            })
          );
          
          // Inventory'den stok d√º≈ü
          const stockUpdatePromises = cart.map(item =>
            supabase.from('inventory').update({ 
              quantity: item.current_stock - item.quantity 
            }).eq('product_id', item.id).eq('depot', item.depot).eq('shelf', item.shelf)
          );
          
          await Promise.all([...saleItemsPromises, ...stockUpdatePromises]);
          
          // Stok 0'a d√º≈üen √ºr√ºnleri kontrol et
          const outOfStockItems = cart.filter(item => (item.current_stock - item.quantity) <= 0);
          if (outOfStockItems.length > 0) {
            const names = outOfStockItems.map(i => i.name).join(', ');
            setTimeout(() => {
              showToast(`‚ö†Ô∏è Stok bitti: ${names}`, 'warning');
            }, 1500);
          }
          
          // Min stok altƒ±na d√º≈üen √ºr√ºnleri kontrol et
          const lowStockItems = cart.filter(item => {
            const newStock = item.current_stock - item.quantity;
            return newStock > 0 && newStock <= (item.min_stock || 0);
          });
          if (lowStockItems.length > 0) {
            const names = lowStockItems.map(i => `${i.name} (${i.current_stock - i.quantity} kaldƒ±)`).join(', ');
            setTimeout(() => {
              showToast(`üìâ D√º≈ü√ºk stok: ${names}`, 'warning');
            }, 3000);
          }
          
          // Son satƒ±≈üƒ± kaydet (yazdƒ±rma i√ßin) - kullanƒ±cƒ± bilgisi dahil
          setLastSale({ 
            id: sale.id, 
            items: cart, 
            subtotal: sub, 
            discount, 
            total: tot, 
            date: new Date(),
            user: user?.full_name || user?.email || 'Bilinmiyor'
          });
          
          showToast(`Satƒ±≈ü: ${formatCurrency(tot)}`, 'success');
          setCart([]);
          setDiscount(0);
          setModal('printReceipt');
          await refreshSearch();
          loadProducts(true);
          loadData(); // Satƒ±≈ülar listesini g√ºncelle
        } catch (err) {
          showToast('Satƒ±≈ü hatasƒ±', 'error');
        }
      }, [cart, discount, user, refreshSearch, loadData]);

      // Satƒ±≈ü fi≈üi yazdƒ±rma
      const printReceipt = useCallback(() => {
        if (!lastSale) return;
        
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`
          <html>
          <head>
            <title>Satƒ±≈ü Fi≈üi #${lastSale.id}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
              .header h1 { margin: 0; font-size: 24px; }
              .info { margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
              th { background: #f0f0f0; font-weight: bold; }
              .total-section { border-top: 2px solid #000; padding-top: 10px; }
              .total-row { display: flex; justify-content: space-between; margin: 5px 0; }
              .total-row.grand { font-size: 18px; font-weight: bold; margin-top: 10px; }
              .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>ü™ô SATI≈û Fƒ∞≈ûƒ∞</h1>
              <p>√úr√ºn Y√∂netim Sistemi</p>
            </div>
            
            <div class="info">
              <p><strong>Fi≈ü No:</strong> #${lastSale.id}</p>
              <p><strong>Tarih:</strong> ${formatDate(lastSale.date)}</p>
              <p><strong>Kasiyer:</strong> ${lastSale.user || user?.full_name || user?.email || 'Bilinmiyor'}</p>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>√úr√ºn</th>
                  <th style="text-align: center;">Adet</th>
                  <th style="text-align: right;">Birim Fiyat</th>
                  <th style="text-align: right;">Toplam</th>
                </tr>
              </thead>
              <tbody>
                ${lastSale.items.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td style="text-align: center;">${item.quantity}</td>
                    <td style="text-align: right;">${formatCurrency(item.price)}</td>
                    <td style="text-align: right;">${formatCurrency(item.price * item.quantity)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div class="total-section">
              <div class="total-row">
                <span>Ara Toplam:</span>
                <span>${formatCurrency(lastSale.subtotal)}</span>
              </div>
              ${lastSale.discount > 0 ? `
                <div class="total-row" style="color: #dc2626;">
                  <span>ƒ∞ndirim (${lastSale.discount}%):</span>
                  <span>-${formatCurrency(lastSale.subtotal * lastSale.discount / 100)}</span>
                </div>
              ` : ''}
              <div class="total-row grand">
                <span>GENEL TOPLAM:</span>
                <span>${formatCurrency(lastSale.total)}</span>
              </div>
            </div>
            
            <div class="footer">
              <p>Bizi tercih ettiƒüiniz i√ßin te≈üekk√ºr ederiz!</p>
              <p style="font-size: 12px; color: #666;">Bu fi≈ü ${formatDate(new Date())} tarihinde olu≈üturulmu≈ütur.</p>
            </div>
          </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }, [lastSale, user]);

      // Se√ßili √ºr√ºnleri yazdƒ±rma
      const printSelectedProducts = useCallback(() => {
        if (selectedProducts.length === 0) return showToast('√úr√ºn se√ßin', 'warning');
        
        const selectedItems = products.filter(p => selectedProducts.includes(p.id));
        
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`
          <html>
          <head>
            <title>√úr√ºn Listesi</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
              .header h1 { margin: 0; font-size: 24px; }
              table { width: 100%; border-collapse: collapse; }
              th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; font-size: 12px; }
              th { background: #f0f0f0; font-weight: bold; }
              .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üì¶ √úR√úN Lƒ∞STESƒ∞</h1>
              <p>Toplam ${selectedItems.length} √ºr√ºn</p>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>√úr√ºn Adƒ±</th>
                  <th>Barkod</th>
                  <th style="text-align: right;">Fiyat</th>
                  <th style="text-align: center;">Stok</th>
                  <th>Depo</th>
                </tr>
              </thead>
              <tbody>
                ${selectedItems.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td>${item.barcode || '-'}</td>
                    <td style="text-align: right;">${formatCurrency(item.price)}</td>
                    <td style="text-align: center;">${item.current_stock}</td>
                    <td>${item.depot || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            
            <div class="footer">
              <p>${formatDate(new Date())} tarihinde olu≈üturuldu</p>
            </div>
          </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }, [selectedProducts, products]);

      // Tek satƒ±≈üƒ± yazdƒ±rma
      const printSale = useCallback((sale) => {
        const printWindow = window.open('', '', 'width=800,height=600');
        printWindow.document.write(`
          <html>
          <head>
            <title>Satƒ±≈ü Fi≈üi #${sale.id}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
              .header h1 { margin: 0; font-size: 24px; }
              .info { margin-bottom: 20px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
              th { background: #f0f0f0; font-weight: bold; }
              .total { text-align: right; font-size: 18px; font-weight: bold; margin-top: 20px; padding-top: 10px; border-top: 2px solid #000; }
              .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>ü™ô SATI≈û Fƒ∞≈ûƒ∞</h1>
            </div>
            
            <div class="info">
              <p><strong>Fi≈ü No:</strong> #${sale.id}</p>
              <p><strong>Tarih:</strong> ${formatDate(sale.created_at)}</p>
              <p><strong>Kasiyer:</strong> ${sale.profiles?.full_name || sale.profiles?.email || 'Bilinmiyor'}</p>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>√úr√ºn</th>
                  <th style="text-align: center;">Adet</th>
                  <th style="text-align: right;">Birim Fiyat</th>
                  <th style="text-align: right;">Toplam</th>
                </tr>
              </thead>
              <tbody>
                ${sale.sale_items?.map(item => `
                  <tr>
                    <td>${item.products?.name || '√úr√ºn'}</td>
                    <td style="text-align: center;">${item.quantity}</td>
                    <td style="text-align: right;">${formatCurrency(item.price)}</td>
                    <td style="text-align: right;">${formatCurrency(item.total)}</td>
                  </tr>
                `).join('') || ''}
              </tbody>
            </table>
            
            <div class="total">
              TOPLAM: ${formatCurrency(sale.total_amount)}
            </div>
            
            <div class="footer">
              <p>Te≈üekk√ºr ederiz!</p>
            </div>
          </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }, []);

      // STOK Gƒ∞Rƒ∞≈û FONKSƒ∞YONLARI
      const addToEntryCart = useCallback((product) => {
        setEntryCart(prev => {
          const existing = prev.find(i => i.id === product.id);
          if (existing) {
            showToast(`${product.name} (${existing.quantity + 1} adet)`, 'success');
            return prev.map(i => i.id === product.id ? { ...i, quantity: i.quantity + 1 } : i);
          }
          showToast(`üì• ${product.name} giri≈ü sepetine eklendi`, 'success');
          return [...prev, { ...product, quantity: 1 }];
        });
      }, []);

      const updateEntryCartQty = useCallback((id, qty) => {
        if (qty <= 0) {
          setEntryCart(prev => prev.filter(i => i.id !== id));
        } else {
          setEntryCart(prev => prev.map(i => i.id === id ? { ...i, quantity: qty } : i));
        }
      }, []);

      const completeEntry = useCallback(async () => {
        if (entryCart.length === 0) return showToast('Giri≈ü sepeti bo≈ü', 'warning');
        if (!entryDepot) return showToast('Depo se√ßin', 'warning');
        if (!entryShelf) return showToast('Raf se√ßin', 'warning');
        
        try {
          showToast('‚è≥ Stok giri≈üi yapƒ±lƒ±yor...', 'info');
          
          for (const item of entryCart) {
            // Mevcut inventory kaydƒ±nƒ± kontrol et
            const { data: existingInv } = await supabase
              .from('inventory')
              .select('*')
              .eq('product_id', item.id)
              .eq('depot', entryDepot)
              .eq('shelf', entryShelf)
              .single();
            
            if (existingInv) {
              // Varsa stok ekle
              await supabase.from('inventory')
                .update({ quantity: existingInv.quantity + item.quantity })
                .eq('id', existingInv.id);
            } else {
              // Yoksa yeni kayƒ±t olu≈ütur
              await supabase.from('inventory').insert({
                product_id: item.id,
                depot: entryDepot,
                shelf: entryShelf,
                quantity: item.quantity
              });
            }
          }
          
          const totalItems = entryCart.reduce((sum, i) => sum + i.quantity, 0);
          showToast(`‚úÖ ${entryCart.length} √ºr√ºn, toplam ${totalItems} adet stok giri≈üi yapƒ±ldƒ±`, 'success');
          
          setEntryCart([]);
          // Depo ve raf se√ßimini koruyoruz, kullanƒ±cƒ± aynƒ± konuma devam edebilir
          
          // Verileri yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Stok giri≈ü hatasƒ±: ' + err.message, 'error');
          console.error(err);
        }
      }, [entryCart, entryDepot, entryShelf, search, performSearch, loadProducts]);

      const applyStockMovement = useCallback(async () => {
        if (!selected || stockMovement.quantity <= 0) return showToast('Miktar girin', 'warning');
        
        // Depo/raf kontrol√º - selected'dan veya stockMovement'tan al
        const depot = selected.depot || stockMovement.depot;
        const shelf = selected.shelf || stockMovement.shelf;
        
        if (!depot || !shelf) return showToast('Depo ve raf se√ßin', 'error');
        
        try {
          // Mevcut inventory kaydƒ±nƒ± bul
          const { data: existingInv } = await supabase
            .from('inventory')
            .select('*')
            .eq('product_id', selected.id)
            .eq('depot', depot)
            .eq('shelf', shelf)
            .single();
          
          let newStock = existingInv ? existingInv.quantity : 0;
          
          if (stockMovement.type === 'in') {
            newStock += stockMovement.quantity;
          } else {
            if (stockMovement.quantity > newStock) return showToast('Yetersiz stok', 'error');
            newStock -= stockMovement.quantity;
          }
          
          if (existingInv) {
            // Mevcut kaydƒ± g√ºncelle
            await supabase.from('inventory').update({ quantity: newStock }).eq('id', existingInv.id);
          } else {
            // Yeni kayƒ±t olu≈ütur
            await supabase.from('inventory').insert({
              product_id: selected.id,
              depot: depot,
              shelf: shelf,
              quantity: newStock
            });
          }
          
          showToast(`Yeni stok: ${newStock} (${depot}/${shelf})`, 'success');
          
          // Stok 0'a d√º≈üt√ºyse uyar
          if (newStock === 0 && stockMovement.type === 'out') {
            setTimeout(() => {
              showToast(`‚ö†Ô∏è "${selected.name}" stoƒüu bitti!`, 'warning');
            }, 1500);
          }
          // Min stok altƒ±na d√º≈üt√ºyse uyar
          else if (newStock > 0 && newStock <= (selected.min_stock || 0) && stockMovement.type === 'out') {
            setTimeout(() => {
              showToast(`üìâ "${selected.name}" d√º≈ü√ºk stokta: ${newStock} kaldƒ±`, 'warning');
            }, 1500);
          }
          
          setModal('');
          setSelected(null);
          setStockMovement({ quantity: 0, type: 'in', depot: '', shelf: '' });
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Stok hatasƒ±: ' + err.message, 'error');
          console.error(err);
        }
      }, [selected, stockMovement, search, performSearch, loadProducts]);

      // Toplu stok ekleme
      const [bulkStockForm, setBulkStockForm] = useState({ depot: '', shelf: '', quantity: 0 });
      
      const applyBulkStock = useCallback(async () => {
        if (selectedProducts.length === 0) return showToast('√úr√ºn se√ßin', 'warning');
        if (!bulkStockForm.depot || !bulkStockForm.shelf) return showToast('Depo ve raf se√ßin', 'error');
        if (bulkStockForm.quantity <= 0) return showToast('Miktar girin', 'warning');
        
        try {
          showToast(`‚è≥ ${selectedProducts.length} √ºr√ºne stok ekleniyor...`, 'info');
          
          // Mevcut inventory kayƒ±tlarƒ±nƒ± kontrol et
          const { data: existingInv } = await supabase
            .from('inventory')
            .select('*')
            .in('product_id', selectedProducts)
            .eq('depot', bulkStockForm.depot)
            .eq('shelf', bulkStockForm.shelf);
          
          const existingMap = new Map((existingInv || []).map(inv => [inv.product_id, inv]));
          
          // G√ºncellenecek ve eklenecek kayƒ±tlarƒ± ayƒ±r
          const toUpdate = [];
          const toInsert = [];
          
          for (const productId of selectedProducts) {
            const existing = existingMap.get(productId);
            if (existing) {
              toUpdate.push({
                id: existing.id,
                quantity: existing.quantity + bulkStockForm.quantity
              });
            } else {
              toInsert.push({
                product_id: productId,
                depot: bulkStockForm.depot,
                shelf: bulkStockForm.shelf,
                quantity: bulkStockForm.quantity
              });
            }
          }
          
          // Toplu g√ºncelleme
          for (const item of toUpdate) {
            await supabase.from('inventory').update({ quantity: item.quantity }).eq('id', item.id);
          }
          
          // Toplu ekleme (batch)
          if (toInsert.length > 0) {
            const { error } = await supabase.from('inventory').insert(toInsert);
            if (error) console.error('Batch insert hatasƒ±:', error);
          }
          
          showToast(`‚úÖ ${selectedProducts.length} √ºr√ºne ${bulkStockForm.quantity} adet stok eklendi`, 'success');
          setModal('');
          setBulkStockForm({ depot: '', shelf: '', quantity: 0 });
          setSelectedProducts([]);
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Toplu stok hatasƒ±: ' + err.message, 'error');
          console.error(err);
        }
      }, [selectedProducts, bulkStockForm, search, performSearch, loadProducts]);

      const handleExcelImport = useCallback((e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          try {
            showToast('‚è≥ Excel okunuyor...', 'info');
            const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            console.log('Excel verileri:', json.length, 'satƒ±r');
            
            // Excel satƒ±rlarƒ±nƒ± i≈üle
            const rows = json.filter(row => row['√úr√ºn Adƒ±'] || row.name || row['name']);
            
            if (rows.length === 0) {
              showToast('Ge√ßerli √ºr√ºn bulunamadƒ±', 'warning');
              return;
            }
            
            showToast(`‚è≥ ${rows.length} √ºr√ºn i≈üleniyor, mevcut √ºr√ºnler y√ºkleniyor...`, 'info');
            
            // Mevcut √ºr√ºn isimlerini ve barkodlarƒ±nƒ± √ßek (pagination ile)
            let existingProducts = [];
            let from = 0;
            const fetchBatchSize = 1000;
            
            while (true) {
              const { data, error } = await supabase
                .from('products')
                .select('name, barcode')
                .range(from, from + fetchBatchSize - 1);
              
              if (error) {
                console.error('√úr√ºn √ßekme hatasƒ±:', error);
                break;
              }
              
              if (!data || data.length === 0) break;
              existingProducts = existingProducts.concat(data);
              
              if (data.length < fetchBatchSize) break;
              from += fetchBatchSize;
            }
            
            console.log('Mevcut √ºr√ºn sayƒ±sƒ±:', existingProducts.length);
            
            const existingNames = new Set();
            const existingBarcodes = new Set();
            
            existingProducts.forEach(p => {
              if (p.name) existingNames.add(p.name.toLowerCase().trim());
              const barcode = String(p.barcode || '').trim();
              if (barcode && barcode !== 'null' && barcode !== 'undefined' && barcode !== '') {
                existingBarcodes.add(barcode.toLowerCase());
              }
            });
            
            console.log('Unique isim sayƒ±sƒ± (DB):', existingNames.size);
            console.log('Unique barkod sayƒ±sƒ± (DB):', existingBarcodes.size);
            
            // Excel'de i≈ülenen barkodlarƒ± takip et (duplicate √∂nleme)
            const processedBarcodes = new Set();
            
            // Yeni √ºr√ºnleri filtrele ve hazƒ±rla
            const newProducts = [];
            let skippedProducts = 0;
            let duplicateProducts = 0;
            
            for (const row of rows) {
              const name = row['√úr√ºn Adƒ±'] || row.name || row['name'];
              const barcode = String(row.Barkod || row.barcode || row['barcode'] || '').trim();
              
              // ƒ∞sim kontrol√º
              if (existingNames.has(name?.toLowerCase().trim())) {
                skippedProducts++;
                continue;
              }
              
              // Barkod kontrol√º (eƒüer barkod varsa)
              if (barcode && barcode !== 'null' && barcode !== 'undefined' && barcode !== '') {
                const barcodeKey = barcode.toLowerCase();
                
                // DB'de bu barkod var mƒ±?
                if (existingBarcodes.has(barcodeKey)) {
                  skippedProducts++;
                  continue;
                }
                
                // Excel'de bu barkod zaten i≈ülendi mi?
                if (processedBarcodes.has(barcodeKey)) {
                  duplicateProducts++;
                  continue;
                }
                
                processedBarcodes.add(barcodeKey);
                existingBarcodes.add(barcodeKey);
              }
              
              const price = parseFloat(row.Fiyat || row.price || row['price'] || 0);
              const min_stock_raw = row['Min Stok'] ?? row.min_stock ?? row['min_stock'];
              const min_stock = (min_stock_raw !== undefined && min_stock_raw !== null && min_stock_raw !== '') 
                ? parseInt(min_stock_raw) 
                : 10;
              
              newProducts.push({ name, barcode: barcode || null, price, min_stock });
              existingNames.add(name?.toLowerCase().trim());
            }
            
            // Toplu insert (1000'lik batch'ler halinde)
            let addedProducts = 0;
            const batchSize = 1000;
            
            for (let i = 0; i < newProducts.length; i += batchSize) {
              const batch = newProducts.slice(i, i + batchSize);
              const { error } = await supabase.from('products').insert(batch);
              
              if (error) {
                console.error('Batch insert hatasƒ±:', error);
              } else {
                addedProducts += batch.length;
              }
              
              // Progress g√∂ster
              if (newProducts.length > batchSize) {
                showToast(`‚è≥ ${Math.min(i + batchSize, newProducts.length)}/${newProducts.length} eklendi...`, 'info');
              }
            }
            
            let message = `‚úÖ ${addedProducts} √ºr√ºn eklendi`;
            if (skippedProducts > 0) message += ` (${skippedProducts} zaten mevcuttu)`;
            if (duplicateProducts > 0) message += ` (${duplicateProducts} duplicate atlandƒ±)`;
            showToast(message, 'success');
            loadProducts(true);
            
            if (fileRef.current) fileRef.current.value = '';
          } catch (err) {
            console.error('Excel okuma hatasƒ±:', err);
            showToast('Excel okuma hatasƒ±: ' + err.message, 'error');
          }
        };
        reader.readAsArrayBuffer(file);
      }, []);

      // BARKOD ƒ∞LE Fƒ∞YAT G√úNCELLEME VE YENƒ∞ √úR√úN EKLEME
      const handlePriceUpdate = useCallback((e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
          try {
            showToast('‚è≥ Excel okunuyor...', 'info');
            const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            console.log('Fiyat g√ºncelleme verileri:', json.length, 'satƒ±r');
            
            // Excel satƒ±rlarƒ±nƒ± i≈üle - Barkod zorunlu
            const rows = json.filter(row => row.Barkod || row.barcode || row['barcode']);
            
            if (rows.length === 0) {
              showToast('Barkod i√ßeren satƒ±r bulunamadƒ±. Excel\'de "Barkod" s√ºtunu olmalƒ±.', 'warning');
              return;
            }
            
            showToast(`‚è≥ ${rows.length} √ºr√ºn i≈üleniyor, mevcut √ºr√ºnler y√ºkleniyor...`, 'info');
            
            // Mevcut √ºr√ºnleri barkod ile √ßek (pagination ile - t√ºm √ºr√ºnler)
            let existingProducts = [];
            let from = 0;
            const fetchBatchSize = 1000;
            
            while (true) {
              const { data, error } = await supabase
                .from('products')
                .select('id, name, barcode, price')
                .range(from, from + fetchBatchSize - 1);
              
              if (error) {
                console.error('√úr√ºn √ßekme hatasƒ±:', error);
                break;
              }
              
              if (!data || data.length === 0) break;
              existingProducts = existingProducts.concat(data);
              
              if (data.length < fetchBatchSize) break;
              from += fetchBatchSize;
            }
            
            console.log('Mevcut √ºr√ºn sayƒ±sƒ±:', existingProducts.length);
            
            // Barkod -> √ºr√ºn map'i olu≈ütur (DB'deki √ºr√ºnler)
            const barcodeMap = new Map();
            existingProducts.forEach(p => {
              const barcode = String(p.barcode || '').trim();
              if (barcode && barcode !== 'null' && barcode !== 'undefined' && barcode !== '') {
                barcodeMap.set(barcode.toLowerCase(), p);
              }
            });
            
            console.log('Unique barkod sayƒ±sƒ± (DB):', barcodeMap.size);
            
            // Excel'de i≈ülenen barkodlarƒ± takip et (duplicate √∂nleme)
            const processedBarcodes = new Set();
            
            let updatedCount = 0;
            let addedCount = 0;
            let skippedCount = 0;
            let duplicateCount = 0;
            const newProducts = [];
            const updatePromises = [];
            
            for (const row of rows) {
              const barcode = String(row.Barkod || row.barcode || row['barcode'] || '').trim();
              const price = parseFloat(row.Fiyat || row.price || row['price'] || 0);
              const name = row['√úr√ºn Adƒ±'] || row.name || row['name'] || '';
              
              if (!barcode) {
                skippedCount++;
                continue;
              }
              
              const barcodeKey = barcode.toLowerCase();
              
              // Excel'de bu barkod zaten i≈ülendi mi? (duplicate satƒ±r)
              if (processedBarcodes.has(barcodeKey)) {
                duplicateCount++;
                continue;
              }
              processedBarcodes.add(barcodeKey);
              
              const existingProduct = barcodeMap.get(barcodeKey);
              
              if (existingProduct) {
                // √úr√ºn var, fiyatƒ± g√ºncelle
                if (price > 0 && existingProduct.price !== price) {
                  updatePromises.push(
                    supabase.from('products')
                      .update({ price: price })
                      .eq('id', existingProduct.id)
                  );
                  updatedCount++;
                } else {
                  skippedCount++;
                }
              } else {
                // √úr√ºn yok, yeni ekle (isim zorunlu)
                if (name && price > 0) {
                  const min_stock_raw = row['Min Stok'] ?? row.min_stock ?? row['min_stock'];
                  const min_stock = (min_stock_raw !== undefined && min_stock_raw !== null && min_stock_raw !== '') 
                    ? parseInt(min_stock_raw) 
                    : 10;
                  
                  newProducts.push({ name, barcode, price, min_stock });
                  // Yeni eklenen √ºr√ºn√º de map'e ekle (aynƒ± Excel'de tekrar gelirse duplicate olmasƒ±n)
                  barcodeMap.set(barcodeKey, { barcode, name, price });
                  addedCount++;
                } else {
                  skippedCount++;
                }
              }
            }
            
            // G√ºncellemeleri toplu yap
            if (updatePromises.length > 0) {
              showToast(`‚è≥ ${updatePromises.length} fiyat g√ºncelleniyor...`, 'info');
              await Promise.all(updatePromises);
            }
            
            // Yeni √ºr√ºnleri toplu ekle
            if (newProducts.length > 0) {
              showToast(`‚è≥ ${newProducts.length} yeni √ºr√ºn ekleniyor...`, 'info');
              const batchSize = 1000;
              for (let i = 0; i < newProducts.length; i += batchSize) {
                const batch = newProducts.slice(i, i + batchSize);
                const { error } = await supabase.from('products').insert(batch);
                if (error) {
                  console.error('Batch insert hatasƒ±:', error);
                }
              }
            }
            
            // Sonu√ß mesajƒ±
            let message = '‚úÖ Fiyat g√ºncelleme tamamlandƒ±: ';
            const parts = [];
            if (updatedCount > 0) parts.push(`${updatedCount} g√ºncellendi`);
            if (addedCount > 0) parts.push(`${addedCount} yeni eklendi`);
            if (duplicateCount > 0) parts.push(`${duplicateCount} duplicate atlandƒ±`);
            if (skippedCount > 0) parts.push(`${skippedCount} atlandƒ±`);
            message += parts.join(', ');
            
            showToast(message, 'success');
            loadProducts(true);
            
            if (priceFileRef.current) priceFileRef.current.value = '';
          } catch (err) {
            console.error('Fiyat g√ºncelleme hatasƒ±:', err);
            showToast('Fiyat g√ºncelleme hatasƒ±: ' + err.message, 'error');
          }
        };
        reader.readAsArrayBuffer(file);
      }, []);

      // DUPLICATE √úR√úN TEMƒ∞ZLEME (Aynƒ± barkodlu veya aynƒ± isimli √ºr√ºnlerden sadece birini tut)
      const cleanDuplicateProducts = useCallback(async () => {
        console.log('=== DUPLICATE TEMƒ∞ZLEME BA≈ûLADI ===');
        
        try {
          showToast('‚è≥ T√ºm √ºr√ºnler y√ºkleniyor...', 'info');
          
          // T√ºm √ºr√ºnleri √ßek (pagination ile - Supabase 1000 limit var)
          let allProducts = [];
          let from = 0;
          const batchSize = 1000;
          
          while (true) {
            const { data, error } = await supabase
              .from('products')
              .select('id, name, barcode, created_at')
              .order('created_at', { ascending: true })
              .range(from, from + batchSize - 1);
            
            if (error) {
              console.error('√úr√ºn √ßekme hatasƒ±:', error);
              showToast('√úr√ºn √ßekme hatasƒ±: ' + error.message, 'error');
              return;
            }
            
            if (!data || data.length === 0) break;
            
            allProducts = allProducts.concat(data);
            console.log(`Y√ºklendi: ${allProducts.length} √ºr√ºn...`);
            
            if (data.length < batchSize) break; // Son sayfa
            from += batchSize;
          }
          
          console.log('Toplam √ºr√ºn:', allProducts.length);
          
          if (allProducts.length === 0) {
            showToast('√úr√ºn bulunamadƒ±', 'warning');
            return;
          }
          
          showToast(`‚è≥ ${allProducts.length} √ºr√ºn tarandƒ±, duplicate aranƒ±yor...`, 'info');
          
          const duplicatesToDelete = [];
          const seenBarcodes = new Map(); // barkod -> ilk √ºr√ºn id
          const seenNames = new Map(); // isim -> ilk √ºr√ºn id
          
          for (const product of allProducts) {
            let isDuplicate = false;
            
            // Barkod kontrol√º - STRING olarak kar≈üƒ±la≈ütƒ±r
            const barcode = String(product.barcode || '').trim();
            if (barcode && barcode !== 'null' && barcode !== 'undefined' && barcode !== '') {
              const barcodeKey = barcode.toLowerCase();
              if (seenBarcodes.has(barcodeKey)) {
                isDuplicate = true;
                console.log(`Duplicate barkod: "${barcode}" - √úr√ºn: ${product.name} (ID: ${product.id})`);
              } else {
                seenBarcodes.set(barcodeKey, product.id);
              }
            }
            
            // ƒ∞sim kontrol√º (barkod duplicate deƒüilse)
            if (!isDuplicate && product.name && product.name.trim()) {
              const nameKey = product.name.toLowerCase().trim();
              if (seenNames.has(nameKey)) {
                isDuplicate = true;
                console.log(`Duplicate isim: "${product.name}" (ID: ${product.id})`);
              } else {
                seenNames.set(nameKey, product.id);
              }
            }
            
            if (isDuplicate) {
              duplicatesToDelete.push(product.id);
            }
          }
          
          console.log('Unique barkod sayƒ±sƒ±:', seenBarcodes.size);
          console.log('Unique isim sayƒ±sƒ±:', seenNames.size);
          console.log('Silinecek duplicate sayƒ±sƒ±:', duplicatesToDelete.length);
          
          if (duplicatesToDelete.length === 0) {
            showToast('‚úÖ Duplicate √ºr√ºn bulunamadƒ±', 'success');
            return;
          }
          
          showToast(`‚è≥ ${duplicatesToDelete.length} duplicate bulundu, siliniyor...`, 'info');
          
          // Batch halinde sil
          let deletedCount = 0;
          let errorCount = 0;
          const deleteBatchSize = 50;
          
          for (let i = 0; i < duplicatesToDelete.length; i += deleteBatchSize) {
            const batch = duplicatesToDelete.slice(i, i + deleteBatchSize);
            
            // Inventory sil
            await supabase.from('inventory').delete().in('product_id', batch);
            
            // √úr√ºn sil
            const { error: delError } = await supabase
              .from('products')
              .delete()
              .in('id', batch);
            
            if (delError) {
              console.error(`Silme hatasƒ±:`, delError);
              errorCount += batch.length;
            } else {
              deletedCount += batch.length;
            }
            
            // Progress g√∂ster
            showToast(`‚è≥ ${Math.min(i + deleteBatchSize, duplicatesToDelete.length)}/${duplicatesToDelete.length} i≈ülendi...`, 'info');
          }
          
          console.log(`Silinen: ${deletedCount}, Hata: ${errorCount}`);
          
          if (deletedCount > 0) {
            showToast(`‚úÖ ${deletedCount} duplicate √ºr√ºn silindi${errorCount > 0 ? ` (${errorCount} hata)` : ''}`, 'success');
            await loadProducts(true);
          } else {
            showToast(`‚ùå Hi√ß √ºr√ºn silinemedi. ${errorCount} hata olu≈ütu.`, 'error');
          }
          
        } catch (err) {
          console.error('Duplicate temizleme hatasƒ±:', err);
          showToast('Hata: ' + err.message, 'error');
        }
        
        console.log('=== DUPLICATE TEMƒ∞ZLEME Bƒ∞TTƒ∞ ===');
      }, [loadProducts]);

      const saveProduct = useCallback(async () => {
        if (!productForm.name || productForm.price <= 0) return showToast('Ad ve fiyat gerekli', 'warning');
        
        try {
          if (selected) {
            // √úr√ºn g√ºncelleme - sadece kendi ID'si dƒ±≈üƒ±nda aynƒ± isim/barkod var mƒ± kontrol et
            const { data: existingByName } = await supabase
              .from('products')
              .select('id, name')
              .ilike('name', productForm.name.trim())
              .neq('id', selected.id)
              .limit(1);
            
            if (existingByName && existingByName.length > 0) {
              return showToast(`‚ö†Ô∏è "${productForm.name}" adƒ±nda bir √ºr√ºn zaten mevcut!`, 'warning');
            }
            
            // Barkod kontrol√º (eƒüer barkod girilmi≈üse)
            if (productForm.barcode && productForm.barcode.trim()) {
              const { data: existingByBarcode } = await supabase
                .from('products')
                .select('id, name, barcode')
                .eq('barcode', productForm.barcode.trim())
                .neq('id', selected.id)
                .limit(1);
              
              if (existingByBarcode && existingByBarcode.length > 0) {
                return showToast(`‚ö†Ô∏è Bu barkod "${existingByBarcode[0].name}" √ºr√ºn√ºne ait!`, 'warning');
              }
            }
            
            // √úr√ºn g√ºncelle
            await supabase.from('products').update({
              name: productForm.name,
              barcode: productForm.barcode,
              price: productForm.price,
              min_stock: productForm.min_stock
            }).eq('id', selected.id);
          } else {
            // Yeni √ºr√ºn ekleme - aynƒ± isimde √ºr√ºn var mƒ± kontrol et
            const { data: existingByName } = await supabase
              .from('products')
              .select('id, name')
              .ilike('name', productForm.name.trim())
              .limit(1);
            
            if (existingByName && existingByName.length > 0) {
              // Inventory'de bu √ºr√ºn hangi depolarda var kontrol et
              const { data: inventoryData } = await supabase
                .from('inventory')
                .select('depot, shelf, quantity')
                .eq('product_id', existingByName[0].id)
                .gt('quantity', 0);
              
              if (inventoryData && inventoryData.length > 0) {
                const locations = inventoryData.map(inv => `${inv.depot}/${inv.shelf} (${inv.quantity} adet)`).join(', ');
                return showToast(`‚ö†Ô∏è "${productForm.name}" zaten mevcut! Konumlar: ${locations}`, 'warning');
              } else {
                return showToast(`‚ö†Ô∏è "${productForm.name}" adƒ±nda bir √ºr√ºn zaten sistemde kayƒ±tlƒ±!`, 'warning');
              }
            }
            
            // Barkod kontrol√º (eƒüer barkod girilmi≈üse)
            if (productForm.barcode && productForm.barcode.trim()) {
              const { data: existingByBarcode } = await supabase
                .from('products')
                .select('id, name, barcode')
                .eq('barcode', productForm.barcode.trim())
                .limit(1);
              
              if (existingByBarcode && existingByBarcode.length > 0) {
                // Inventory'de bu √ºr√ºn hangi depolarda var kontrol et
                const { data: inventoryData } = await supabase
                  .from('inventory')
                  .select('depot, shelf, quantity')
                  .eq('product_id', existingByBarcode[0].id)
                  .gt('quantity', 0);
                
                if (inventoryData && inventoryData.length > 0) {
                  const locations = inventoryData.map(inv => `${inv.depot}/${inv.shelf} (${inv.quantity} adet)`).join(', ');
                  return showToast(`‚ö†Ô∏è Bu barkod "${existingByBarcode[0].name}" √ºr√ºn√ºne ait! Konumlar: ${locations}`, 'warning');
                } else {
                  return showToast(`‚ö†Ô∏è Bu barkod "${existingByBarcode[0].name}" √ºr√ºn√ºne ait!`, 'warning');
                }
              }
            }
            
            // Yeni √ºr√ºn ekle
            await supabase.from('products').insert({ 
              name: productForm.name,
              barcode: productForm.barcode,
              price: productForm.price,
              min_stock: productForm.min_stock ?? 10
            });
          }
          showToast('√úr√ºn kaydedildi', 'success');
          setModal('');
          setSelected(null);
          setProductForm({ name: '', barcode: '', price: 0, min_stock: 10 });
          loadProducts(true);
        } catch (err) {
          showToast('Kaydetme hatasƒ±: ' + err.message, 'error');
        }
      }, [productForm, selected]);

      // Tek √ºr√ºn stoƒüunu sƒ±fƒ±rla (inventory'den kaydƒ± sil)
      const deleteProduct = useCallback(async (product) => {
        try {
          await supabase.from('inventory')
            .delete()
            .eq('product_id', product.id)
            .eq('depot', product.depot)
            .eq('shelf', product.shelf);
          showToast(`"${product.name}" stoƒüu sƒ±fƒ±rlandƒ± ve depo/raf bilgisi temizlendi`, 'success');
          setModal('');
          setSelected(null);
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Stok sƒ±fƒ±rlama hatasƒ±', 'error');
        }
      }, [search, performSearch, loadProducts]);

      // Toplu √ºr√ºn stoƒüunu sƒ±fƒ±rla (inventory'den kayƒ±tlarƒ± sil)
      const deleteSelectedProducts = useCallback(async () => {
        if (selectedProducts.length === 0) return showToast('√úr√ºn se√ßin', 'warning');
        try {
          // Se√ßili √ºr√ºnlerin inventory kayƒ±tlarƒ±nƒ± sil
          for (const productId of selectedProducts) {
            await supabase.from('inventory').delete().eq('product_id', productId);
          }
          showToast(`${selectedProducts.length} √ºr√ºn√ºn stoƒüu sƒ±fƒ±rlandƒ± ve depo/raf bilgileri temizlendi`, 'success');
          setSelectedProducts([]);
          setModal('');
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Toplu stok sƒ±fƒ±rlama hatasƒ±', 'error');
        }
      }, [selectedProducts, search, performSearch, loadProducts]);

      // Depo kaydet
      const saveDepot = useCallback(async () => {
        if (!depotForm.name.trim()) return showToast('Depo adƒ± gerekli', 'warning');
        if (!depotForm.location.trim()) return showToast('Konum gerekli', 'warning');
        try {
          // Aynƒ± isimde depo var mƒ± kontrol et
          const { data: existing } = await supabase
            .from('depots')
            .select('id')
            .eq('name', depotForm.name.trim())
            .single();
          
          if (existing && (!selectedDepot || existing.id !== selectedDepot.id)) {
            return showToast('Bu isimde depo zaten var!', 'warning');
          }
          
          if (selectedDepot) {
            await supabase.from('depots').update(depotForm).eq('id', selectedDepot.id);
            showToast('Depo g√ºncellendi', 'success');
          } else {
            await supabase.from('depots').insert(depotForm);
            showToast('Depo eklendi', 'success');
          }
          setModal('');
          setSelectedDepot(null);
          setDepotForm({ name: '', location: '', description: '' });
          loadData();
        } catch (err) {
          showToast('Depo kaydetme hatasƒ±', 'error');
        }
      }, [depotForm, selectedDepot]);

      // Depo sil
      const deleteDepot = useCallback(async () => {
        if (!selectedDepot) return;
        try {
          const { count } = await supabase.from('products').select('*', { count: 'exact', head: true }).eq('depot', selectedDepot.name);
          if (count > 0) {
            return showToast(`Bu depoda ${count} √ºr√ºn var. √ñnce √ºr√ºnleri ta≈üƒ±yƒ±n.`, 'warning');
          }
          // √ñnce raflarƒ± sil
          await supabase.from('shelves').delete().eq('depot_id', selectedDepot.id);
          await supabase.from('depots').delete().eq('id', selectedDepot.id);
          showToast('Depo silindi', 'success');
          setModal('');
          setSelectedDepot(null);
          loadData();
        } catch (err) {
          showToast('Depo silme hatasƒ±', 'error');
        }
      }, [selectedDepot]);

      // Raf kaydet
      const saveShelf = useCallback(async () => {
        if (!shelfForm.name.trim()) return showToast('Raf adƒ± gerekli', 'warning');
        if (!shelfForm.depot_id) return showToast('Depo se√ßin', 'warning');
        try {
          // Aynƒ± depoda aynƒ± isimde raf var mƒ± kontrol et
          const { data: existing } = await supabase
            .from('shelves')
            .select('id')
            .eq('depot_id', shelfForm.depot_id)
            .eq('name', shelfForm.name.trim())
            .single();
          
          if (existing && (!selectedShelf || existing.id !== selectedShelf.id)) {
            return showToast('Bu depoda aynƒ± isimde raf zaten var!', 'warning');
          }
          
          if (selectedShelf) {
            await supabase.from('shelves').update({ name: shelfForm.name, description: shelfForm.description }).eq('id', selectedShelf.id);
            showToast('Raf g√ºncellendi', 'success');
          } else {
            await supabase.from('shelves').insert(shelfForm);
            showToast('Raf eklendi', 'success');
          }
          setModal('');
          setSelectedShelf(null);
          setShelfForm({ name: '', depot_id: '', description: '' });
          loadData();
        } catch (err) {
          showToast('Raf kaydetme hatasƒ±', 'error');
        }
      }, [shelfForm, selectedShelf]);

      // Raf sil
      const deleteShelf = useCallback(async () => {
        if (!selectedShelf) return;
        try {
          const { count } = await supabase.from('products').select('*', { count: 'exact', head: true }).eq('shelf', selectedShelf.name);
          if (count > 0) {
            return showToast(`Bu rafta ${count} √ºr√ºn var. √ñnce √ºr√ºnleri ta≈üƒ±yƒ±n.`, 'warning');
          }
          await supabase.from('shelves').delete().eq('id', selectedShelf.id);
          showToast('Raf silindi', 'success');
          setModal('');
          setSelectedShelf(null);
          loadData();
        } catch (err) {
          showToast('Raf silme hatasƒ±', 'error');
        }
      }, [selectedShelf]);

      // Tek √ºr√ºn ta≈üƒ± (t√ºm stok)
      const transferProduct = useCallback(async () => {
        if (!selected) return;
        if (!transferForm.depot) return showToast('Hedef depo se√ßin', 'warning');
        if (!transferForm.shelf) return showToast('Hedef raf se√ßin', 'warning');
        
        // Aynƒ± konuma ta≈üƒ±ma kontrol√º
        if (transferForm.depot === selected.depot && transferForm.shelf === selected.shelf) {
          return showToast('√úr√ºn zaten bu konumda!', 'warning');
        }
        
        try {
          const transferQty = selected.current_stock;
          
          // Hedef inventory'de kayƒ±t var mƒ± kontrol et
          const { data: existingInv } = await supabase
            .from('inventory')
            .select('*')
            .eq('product_id', selected.id)
            .eq('depot', transferForm.depot)
            .eq('shelf', transferForm.shelf)
            .single();
          
          if (existingInv) {
            // Hedefte varsa stok ekle
            await supabase.from('inventory')
              .update({ quantity: existingInv.quantity + transferQty })
              .eq('id', existingInv.id);
          } else {
            // Hedefte yoksa yeni kayƒ±t olu≈ütur
            await supabase.from('inventory').insert({
              product_id: selected.id,
              depot: transferForm.depot,
              shelf: transferForm.shelf,
              quantity: transferQty
            });
          }
          
          // Kaynak inventory kaydƒ±nƒ± sil
          await supabase.from('inventory')
            .delete()
            .eq('product_id', selected.id)
            .eq('depot', selected.depot)
            .eq('shelf', selected.shelf);
          
          showToast(`${transferQty} adet "${selected.name}" ta≈üƒ±ndƒ±: ${transferForm.depot}/${transferForm.shelf}`, 'success');
          
          setModal('');
          setSelected(null);
          setTransferForm({ depot: '', shelf: '', quantity: 0 });
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Ta≈üƒ±ma hatasƒ±', 'error');
          console.error(err);
        }
      }, [selected, transferForm, search, performSearch, loadProducts]);

      // Toplu √ºr√ºn ta≈üƒ± (t√ºm stok)
      const transferSelectedProducts = useCallback(async () => {
        if (selectedProducts.length === 0) return showToast('√úr√ºn se√ßin', 'warning');
        if (!transferForm.depot) return showToast('Hedef depo se√ßin', 'warning');
        if (!transferForm.shelf) return showToast('Hedef raf se√ßin', 'warning');
        try {
          // Her se√ßili √ºr√ºn i√ßin
          for (const productId of selectedProducts) {
            // Bu √ºr√ºn√ºn t√ºm inventory kayƒ±tlarƒ±nƒ± al
            const { data: invRecords } = await supabase
              .from('inventory')
              .select('*')
              .eq('product_id', productId);
            
            if (!invRecords || invRecords.length === 0) continue;
            
            // Toplam stoƒüu hesapla
            const totalQty = invRecords.reduce((sum, inv) => sum + inv.quantity, 0);
            
            // Hedefte kayƒ±t var mƒ± kontrol et
            const { data: existingInv } = await supabase
              .from('inventory')
              .select('*')
              .eq('product_id', productId)
              .eq('depot', transferForm.depot)
              .eq('shelf', transferForm.shelf)
              .single();
            
            if (existingInv) {
              // Hedefte varsa stok g√ºncelle
              await supabase.from('inventory')
                .update({ quantity: existingInv.quantity + totalQty })
                .eq('id', existingInv.id);
              
              // Diƒüer t√ºm kayƒ±tlarƒ± sil (hedef hari√ß)
              await supabase.from('inventory')
                .delete()
                .eq('product_id', productId)
                .neq('id', existingInv.id);
            } else {
              // Hedefte yoksa t√ºm kayƒ±tlarƒ± sil ve yeni olu≈ütur
              await supabase.from('inventory')
                .delete()
                .eq('product_id', productId);
              
              await supabase.from('inventory').insert({
                product_id: productId,
                depot: transferForm.depot,
                shelf: transferForm.shelf,
                quantity: totalQty
              });
            }
          }
          
          showToast(`${selectedProducts.length} √ºr√ºn ta≈üƒ±ndƒ±: ${transferForm.depot}/${transferForm.shelf}`, 'success');
          setModal('');
          setSelectedProducts([]);
          setTransferForm({ depot: '', shelf: '', quantity: 0 });
          
          // √ñnce √ºr√ºnleri y√ºkle, sonra aramayƒ± yenile
          await loadProducts(true);
          if (search.trim().length >= 3) {
            await performSearch(search, true);
          }
        } catch (err) {
          showToast('Toplu ta≈üƒ±ma hatasƒ±', 'error');
          console.error(err);
        }
      }, [selectedProducts, transferForm, search, performSearch, loadProducts]);

      // √ñrnek depo ve raflarƒ± olu≈ütur
      const createSampleDepot = useCallback(async () => {
        try {
          // √ñnce "Ana Depo" var mƒ± kontrol et
          const { data: existingDepot } = await supabase
            .from('depots')
            .select('id')
            .eq('name', 'Ana Depo')
            .single();
          
          if (existingDepot) {
            showToast('Ana Depo zaten mevcut!', 'warning');
            return;
          }
          
          showToast('√ñrnek veriler olu≈üturuluyor...', 'success');
          
          // √ñrnek depo olu≈ütur
          const { data: newDepot, error: depotError } = await supabase.from('depots').insert({
            name: 'Ana Depo',
            location: 'Merkez',
            description: 'Ana merkez deposu'
          }).select().single();
          
          if (depotError) {
            console.error('Depo olu≈üturma hatasƒ±:', depotError);
            showToast('Depo olu≈üturulamadƒ±: ' + depotError.message, 'error');
            return;
          }
          
          if (newDepot) {
            // 5 √∂rnek raf olu≈ütur
            const raflar = [
              { name: 'A-1', depot_id: newDepot.id, description: 'Sol koridor, alt raf' },
              { name: 'A-2', depot_id: newDepot.id, description: 'Sol koridor, √ºst raf' },
              { name: 'B-1', depot_id: newDepot.id, description: 'Orta koridor, alt raf' },
              { name: 'B-2', depot_id: newDepot.id, description: 'Orta koridor, √ºst raf' },
              { name: 'C-1', depot_id: newDepot.id, description: 'Saƒü koridor, tek raf' }
            ];
            
            const { error: shelfError } = await supabase.from('shelves').insert(raflar);
            
            if (shelfError) {
              console.error('Raf olu≈üturma hatasƒ±:', shelfError);
              showToast('Raflar olu≈üturulamadƒ±: ' + shelfError.message, 'error');
              return;
            }
            
            showToast('√ñrnek depo ve 5 raf olu≈üturuldu!', 'success');
          }
          
          loadData();
        } catch (err) {
          showToast('√ñrnek veri olu≈üturma hatasƒ±: ' + err.message, 'error');
          console.error(err);
        }
      }, []);

      const stats = useMemo(() => {
        // Toplam stok miktarƒ± (t√ºm inventory quantity'lerinin toplamƒ±)
        const totalStock = inventory.reduce((sum, inv) => sum + (inv.quantity || 0), 0);
        // Toplam stok deƒüeri (fiyat x miktar)
        const totalStockValue = inventory.reduce((sum, inv) => sum + ((inv.price || 0) * (inv.quantity || 0)), 0);
        // Stokta olan farklƒ± √ºr√ºn sayƒ±sƒ±
        const stockedProductCount = new Set(inventory.filter(inv => inv.quantity > 0).map(inv => inv.product_id)).size;
        return {
          totalProducts: products.length,
          totalStock: totalStock,
          totalStockValue: totalStockValue,
          stockedProductCount: stockedProductCount,
          totalSales: sales.length,
          totalDepots: depots.length
        };
      }, [products, sales, depots, inventory]);

      const filteredProducts = useMemo(() => {
        // Arama sonu√ßlarƒ± varsa onlarƒ± kullan
        if (searchResults.length > 0) {
          let filtered = searchResults;
          if (depotFilter !== 'all') filtered = filtered.filter(p => p.depot === depotFilter);
          if (showOnlyInStock) filtered = filtered.filter(p => p.current_stock > 0);
          return filtered;
        }
        // Yoksa products zaten filtrelenmi≈ü geliyor
        return products;
      }, [products, searchResults, depotFilter, showOnlyInStock]);

      const cartTotal = useMemo(() => cart.reduce((s, i) => s + (i.price * i.quantity), 0), [cart]);
      const cartFinal = useMemo(() => cartTotal - (cartTotal * discount / 100), [cartTotal, discount]);

      // Sayfalama hesaplamalarƒ± (sunucu tarafƒ±nda)
      const totalPages = useMemo(() => Math.ceil(totalProducts / itemsPerPage), [totalProducts, itemsPerPage]);

      // Filtre deƒüi≈üince sayfayƒ± sƒ±fƒ±rla
      useEffect(() => {
        setCurrentPage(1);
      }, [depotFilter, showOnlyInStock, search, itemsPerPage]);

      if (initialLoading) return <LoadingSpinner />;

      if (!user) {
        return (
          <>
          <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
            {toast && <Toast {...toast} onClose={() => setToast(null)} />}
            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <h1 className="text-3xl font-bold text-center mb-2">ü™ô √úr√ºn Y√∂netim v3.3</h1>
              <p className="text-center text-gray-600 mb-6">{authMode === 'login' ? 'Hesabƒ±nƒ±za giri≈ü yapƒ±n' : 'Yeni hesap olu≈üturun'}</p>
              
              <form onSubmit={authMode === 'login' ? handleLogin : handleRegister} className="space-y-4">
                {authMode === 'register' && (
                  <div>
                    <label className="block text-sm font-semibold mb-2">Ad Soyad</label>
                    <input 
                      type="text" 
                      value={authForm.fullName} 
                      onChange={(e) => setAuthForm({...authForm, fullName: e.target.value})}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                      placeholder="Ad Soyad"
                    />
                  </div>
                )}
                
                <div>
                  <label className="block text-sm font-semibold mb-2">Email</label>
                  <input 
                    type="email" 
                    value={authForm.email} 
                    onChange={(e) => setAuthForm({...authForm, email: e.target.value})}
                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="ornek@email.com"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-semibold mb-2">≈ûifre</label>
                  <input 
                    type="password" 
                    value={authForm.password} 
                    onChange={(e) => setAuthForm({...authForm, password: e.target.value})}
                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder={authMode === 'register' ? 'En az 6 karakter' : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                  />
                </div>
                
                <button 
                  type="submit" 
                  disabled={authLoading}
                  className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 font-semibold disabled:opacity-50"
                >
                  {authLoading ? '‚è≥ Bekleyin...' : authMode === 'login' ? 'üîê Giri≈ü Yap' : 'üìù Kayƒ±t Ol'}
                </button>
              </form>
              
              <div className="mt-6 text-center">
                <p className="text-gray-600">
                  {authMode === 'login' ? 'Hesabƒ±nƒ±z yok mu?' : 'Zaten hesabƒ±nƒ±z var mƒ±?'}
                  <button 
                    onClick={() => {
                      setAuthMode(authMode === 'login' ? 'register' : 'login');
                      setAuthForm({ email: '', password: '', fullName: '' });
                    }}
                    className="ml-2 text-blue-600 font-semibold hover:underline"
                  >
                    {authMode === 'login' ? 'Kayƒ±t Ol' : 'Giri≈ü Yap'}
                  </button>
                </p>
              </div>
              
              <div className="mt-6 pt-6 border-t">
                <button 
                  onClick={() => setUser({ id: 'demo', email: 'demo@test.com', full_name: 'Demo Kullanƒ±cƒ±' })}
                  className="w-full bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200 font-semibold"
                >
                  üéÆ Demo ile Dene
                </button>
              </div>
            </div>
          </div>
          
          {/* Kayƒ±t Onay Modalƒ± */}
          {pendingRegister && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                <h2 className="text-2xl font-bold mb-4 text-center">üë§ Kullanƒ±cƒ± Olu≈ütur</h2>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700 mb-3">A≈üaƒüƒ±daki bilgilerle yeni kullanƒ±cƒ± olu≈üturulacak:</p>
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Ad Soyad:</span>
                      <span className="font-semibold">{pendingRegister.fullName}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">E-posta:</span>
                      <span className="font-semibold">{pendingRegister.email}</span>
                    </div>
                  </div>
                </div>
                
                <p className="text-center text-gray-600 mb-4">Bu kullanƒ±cƒ±yƒ± olu≈üturmak istiyor musunuz?</p>
                
                <div className="flex gap-3">
                  <button 
                    onClick={confirmRegister}
                    disabled={authLoading}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold disabled:opacity-50"
                  >
                    {authLoading ? '‚è≥ Olu≈üturuluyor...' : '‚úÖ Evet, Olu≈ütur'}
                  </button>
                  <button 
                    onClick={() => setPendingRegister(null)}
                    disabled={authLoading}
                    className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300 font-semibold"
                  >
                    ƒ∞ptal
                  </button>
                </div>
              </div>
            </div>
          )}
          </>
        );
      }

      if (loading) return <LoadingSpinner />;

      return (
        <div className="min-h-screen bg-gray-100">
          {toast && <Toast {...toast} onClose={() => setToast(null)} />}

          <nav className="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg mb-6">
            <div className="max-w-7xl mx-auto px-6 py-4">
              <div className="flex justify-between items-center">
                <div className="flex gap-2 flex-wrap">
                  {['home', 'entry', 'pos', 'products', 'sales', 'reports', 'settings'].map(p => (
                    <button key={p} onClick={() => setPage(p)} className={`px-4 py-2 rounded-lg ${page === p ? 'bg-white text-blue-600' : 'text-white hover:bg-white/20'}`}>
                      {p === 'home' ? 'üè† Ana' : p === 'entry' ? 'üì• Stok Giri≈ü' : p === 'pos' ? 'üí∞ Satƒ±≈ü' : p === 'products' ? 'üì¶ √úr√ºnler' : p === 'sales' ? 'üìä Satƒ±≈ülar' : p === 'reports' ? 'üìà Raporlar' : '‚öôÔ∏è Ayarlar'}
                    </button>
                  ))}
                </div>
                <div className="flex items-center gap-4">
                  <span className="text-white">üë§ {user.full_name}</span>
                  <button onClick={handleLogout} className="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30 font-semibold">üö™ √áƒ±kƒ±≈ü</button>
                </div>
              </div>
            </div>
          </nav>

          <div className="max-w-7xl mx-auto px-6 pb-6">
            {page === 'home' && (
              <div className="space-y-6">
                <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                  <h1 className="text-2xl font-bold">üöÄ √úr√ºn Y√∂netim v3.3</h1>
                  <p>Geli≈ütirilmi≈ü & Optimize</p>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <StatsCard title="Toplam Stok" value={stats.totalStock} gradient="from-blue-500 to-cyan-500" icon="üì¶" />
                  <StatsCard title="Satƒ±≈ülar" value={stats.totalSales} gradient="from-green-500 to-emerald-500" icon="üí∞" />
                  <StatsCard title="Depolar" value={stats.totalDepots} gradient="from-orange-500 to-red-500" icon="üè¨" />
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">üîç Arama</h3>
                  <SearchBar value={search} onChange={setSearch} onSearch={() => performSearch(search)} onClear={() => { setSearch(''); setSearchResults([]); }} searching={searching} />
                </div>

                {/* Giri≈ü Sepeti √ñzeti */}
                {entryCart.length > 0 && (
                  <div className="bg-gradient-to-r from-teal-500 to-green-500 rounded-xl p-4 text-white shadow-lg">
                    <div className="flex justify-between items-center">
                      <div className="flex items-center gap-3">
                        <DollyIcon size={40} color="white" />
                        <div>
                          <p className="font-bold">Giri≈ü Sepeti: {entryCart.length} √ºr√ºn, {entryCart.reduce((sum, i) => sum + i.quantity, 0)} adet</p>
                          <p className="text-sm opacity-90">
                            {entryDepot && entryShelf ? `üìç ${entryDepot} / ${entryShelf}` : '‚ö†Ô∏è Depo ve raf se√ßilmedi'}
                          </p>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setPage('entry')} className="bg-white text-teal-600 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold">
                          Stok Giri≈ü Sayfasƒ±na Git ‚Üí
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {searchResults.length > 0 && (
                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold">üîç Sonu√ßlar ({searchResults.length})</h3>
                      <div className="flex gap-2">
                        {selectedProducts.length > 0 && (
                          <button onClick={printSelectedProducts} className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 font-semibold">üñ®Ô∏è Se√ßilenleri Yazdƒ±r ({selectedProducts.length})</button>
                        )}
                        <button onClick={() => { setSearch(''); setSearchResults([]); setSelectedProducts([]); }} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">‚úï Temizle</button>
                      </div>
                    </div>
                    
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 mb-4">
                      <div className="flex justify-between items-center">
                        <p className="text-blue-800">
                          üîé "<strong>{search}</strong>" i√ßin {searchResults.length} sonu√ß bulundu
                        </p>
                        <label className="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded-lg border border-blue-300">
                          <input 
                            type="checkbox" 
                            checked={selectedProducts.length === searchResults.length && searchResults.length > 0}
                            onChange={() => {
                              const visibleIds = searchResults.map(p => p.id);
                              setSelectedProducts(prev => prev.length === visibleIds.length ? [] : visibleIds);
                            }}
                            className="w-4 h-4 rounded" 
                          />
                          <span className="text-sm font-semibold text-blue-700">T√ºm√ºn√º Se√ß</span>
                        </label>
                      </div>
                    </div>

                    <div className="space-y-4">
                      {searchResults.map(p => (
                        <ProductCard key={`${p.id}-${p.depot}-${p.shelf}`} product={p} cart={cart} entryCart={entryCart} onSelect={toggleProductSelection} onAddToCart={addToCart} onAddToEntry={addToEntryCart} onStock={(pr) => { setSelected(pr); setStockMovement({ quantity: 0, type: 'in' }); setModal('stockConfirm'); }} onTransfer={(pr) => { setSelected(pr); setTransferForm({ depot: '', shelf: '', quantity: pr.current_stock }); setModal('transfer'); }} onEdit={(pr) => { setSelected(pr); setProductForm({ name: pr.name, barcode: pr.barcode || '', price: pr.price, min_stock: pr.min_stock || 10 }); setModal('productForm'); }} onDelete={(pr) => { setSelected(pr); setModal('confirmDelete'); }} isSelected={selectedProducts.includes(p.id)} />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {page === 'products' && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <div className="flex justify-between mb-6">
                  <h2 className="text-2xl font-bold">üì¶ √úr√ºnler ({totalProducts})</h2>
                  <div className="flex gap-2 flex-wrap">
                    {selectedProducts.length > 0 && (
                      <>
                        <button onClick={() => { setBulkStockForm({ depot: '', shelf: '', quantity: 0 }); setModal('bulkStock'); }} className="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold" title="Se√ßili √úr√ºnlere Toplu Stok Ekle">üì¶ Stok Ekle ({selectedProducts.length})</button>
                        <button onClick={() => { setTransferForm({ depot: '', shelf: '', quantity: 0 }); setModal('transferSelected'); }} className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold" title="Se√ßili √úr√ºnleri Ta≈üƒ±">üöö Ta≈üƒ± ({selectedProducts.length})</button>
                        <button onClick={() => setModal('confirmDeleteSelected')} className="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold" title="Se√ßili √úr√ºnlerin Stoƒüunu Sƒ±fƒ±rla">üîª Sƒ±fƒ±rla ({selectedProducts.length})</button>
                        <button onClick={printSelectedProducts} className="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 font-semibold" title="Se√ßili √úr√ºnleri Yazdƒ±r">üñ®Ô∏è Yazdƒ±r</button>
                      </>
                    )}
                    <button onClick={() => { setProductForm({ name: '', barcode: '', price: 0, cost_price: 0, stock: 0, min_stock: 10, category_id: '', depot: '', shelf: '' }); setSelected(null); setModal('productForm'); }} className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600" title="Yeni √úr√ºn Ekle">+ Yeni</button>
                  </div>
                </div>

                <div className="space-y-4 mb-4">
                  <SearchBar value={search} onChange={setSearch} onSearch={() => performSearch(search)} onClear={() => { setSearch(''); setSearchResults([]); }} searching={searching} />
                  
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <label className="block font-semibold mb-2">üè¨ Depo</label>
                      <select value={depotFilter} onChange={(e) => setDepotFilter(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg">
                        <option value="all">T√ºm Depolar</option>
                        {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block font-semibold mb-2">üì¶ Stok Filtresi</label>
                      <select value={showOnlyInStock ? 'instock' : 'all'} onChange={(e) => setShowOnlyInStock(e.target.value === 'instock')} className="w-full px-4 py-3 border-2 rounded-lg">
                        <option value="instock">‚úÖ Stokta Olanlar</option>
                        <option value="all">üìã T√ºm√º</option>
                      </select>
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">üìÑ Sayfa Limiti</label>
                      <select value={itemsPerPage} onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }} className="w-full px-4 py-3 border-2 rounded-lg">
                        {[25, 50, 100, 250].map(n => (
                          <option key={n} value={n}>{n} √ºr√ºn</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="font-bold text-blue-800 text-lg">
                          {searchResults.length > 0 
                            ? `üîç ${searchResults.length} sonu√ßtan ${filteredProducts.length} g√∂steriliyor`
                            : `${totalProducts} √ºr√ºnden ${products.length} g√∂steriliyor`
                          }
                        </p>
                        <p className="text-sm text-blue-600">
                          {search && `üîé "${search}" ‚Ä¢ `}
                          {depotFilter !== 'all' && `üìç ${depotFilter} ‚Ä¢ `}
                          {showOnlyInStock ? '‚úÖ Stokta' : 'üì¶ T√ºm√º'} ‚Ä¢ 
                          {searchResults.length === 0 && `üìÑ Sayfa ${currentPage}/${totalPages || 1} ‚Ä¢ `}
                          {selectedProducts.length} se√ßildi
                        </p>
                      </div>
                      {(depotFilter !== 'all' || !showOnlyInStock || search) && (
                        <button onClick={() => { setDepotFilter('all'); setShowOnlyInStock(true); setSearch(''); setSearchResults([]); }} className="bg-blue-500 text-white px-4 py-2 rounded-lg">‚úï Temizle</button>
                      )}
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  {filteredProducts.length === 0 ? (
                    <div className="text-center py-16">
                      <div className="text-6xl mb-4">üîç</div>
                      <h3 className="text-2xl font-bold mb-2">{searchResults.length > 0 ? 'Filtre sonucu bo≈ü' : '√úr√ºn Bulunamadƒ±'}</h3>
                      <p className="text-gray-600 mb-4">{search ? `"${search}" i√ßin sonu√ß yok` : depotFilter !== 'all' ? `"${depotFilter}" deposunda ${showOnlyInStock ? 'stokta ' : ''}√ºr√ºn yok` : showOnlyInStock ? 'Stokta √ºr√ºn yok' : 'Hi√ß √ºr√ºn yok'}</p>
                      <button onClick={() => { setDepotFilter('all'); setShowOnlyInStock(false); setSearch(''); setSearchResults([]); }} className="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">T√ºm√ºn√º G√∂ster</button>
                    </div>
                  ) : (
                    <>
                      <div className="flex items-center gap-4 bg-gray-50 rounded-lg p-3">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={selectedProducts.length === filteredProducts.length && filteredProducts.length > 0}
                            onChange={() => {
                              const visibleIds = filteredProducts.map(p => p.id);
                              setSelectedProducts(prev => prev.length === visibleIds.length ? [] : visibleIds);
                            }}
                            className="w-5 h-5 rounded" 
                          />
                          <span className="font-semibold">T√ºm√ºn√º Se√ß/Kaldƒ±r</span>
                        </label>
                        <span className="text-sm text-gray-600">({selectedProducts.length} √ºr√ºn se√ßildi)</span>
                      </div>
                      {filteredProducts.map(p => (
                        <ProductCard key={`${p.id}-${p.depot}-${p.shelf}`} product={p} cart={cart} entryCart={entryCart} onSelect={toggleProductSelection} onAddToCart={addToCart} onAddToEntry={addToEntryCart} onStock={(pr) => { setSelected(pr); setStockMovement({ quantity: 0, type: 'in' }); setModal('stockConfirm'); }} onTransfer={(pr) => { setSelected(pr); setTransferForm({ depot: '', shelf: '', quantity: pr.current_stock }); setModal('transfer'); }} onEdit={(pr) => { setSelected(pr); setProductForm({ name: pr.name, barcode: pr.barcode || '', price: pr.price, min_stock: pr.min_stock || 10 }); setModal('productForm'); }} onDelete={(pr) => { setSelected(pr); setModal('confirmDelete'); }} isSelected={selectedProducts.includes(p.id)} />
                      ))}
                      {/* Pagination sadece arama yokken g√∂ster */}
                      {searchResults.length === 0 && (
                        <Pagination 
                          currentPage={currentPage}
                          totalPages={totalPages}
                          onPageChange={setCurrentPage}
                          totalItems={totalProducts}
                          itemsPerPage={itemsPerPage}
                        />
                      )}
                    </>
                  )}
                </div>
              </div>
            )}

            {page === 'settings' && (
              <div className="space-y-6">
                {/* √úst Bar */}
                <div className="bg-gradient-to-r from-gray-700 to-gray-900 rounded-xl p-6 text-white shadow-lg">
                  <h1 className="text-2xl font-bold">‚öôÔ∏è Ayarlar</h1>
                  <p>Sistem ayarlarƒ±, depolar ve veri y√∂netimi</p>
                </div>

                {/* Sistem Bilgisi */}
                <div className="grid grid-cols-4 gap-4">
                  <div className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Toplam Stok</p>
                    <p className="text-3xl font-bold mt-2">{stats.totalStock} adet</p>
                    <p className="text-sm opacity-80 mt-1">t√ºm depolarda</p>
                  </div>
                  <div className="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Stoktaki √úr√ºn</p>
                    <p className="text-3xl font-bold mt-2">{stats.stockedProductCount}</p>
                    <p className="text-sm opacity-80 mt-1">farklƒ± √ºr√ºn</p>
                  </div>
                  <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Stok Deƒüeri (PSF)</p>
                    <p className="text-3xl font-bold mt-2">{formatCurrency(stats.totalStockValue)}</p>
                    <p className="text-sm opacity-80 mt-1">toplam deƒüer</p>
                  </div>
                  <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Depolar & Raflar</p>
                    <p className="text-3xl font-bold mt-2">{depots.length} / {shelves.length}</p>
                    <p className="text-sm opacity-80 mt-1">depo / raf</p>
                  </div>
                </div>

                {/* Depolar & Raflar */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-bold">üè¨ Depolar & Raflar</h2>
                    <div className="flex gap-2">
                      <button 
                        onClick={createSampleDepot}
                        className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 font-semibold"
                      >
                        üîÑ √ñrnek Depo
                      </button>
                      <button 
                        onClick={() => { 
                          setDepotForm({ name: '', location: '', description: '' }); 
                          setSelectedDepot(null); 
                          setModal('depotForm'); 
                        }} 
                        className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold"
                      >
                        + Yeni Depo
                      </button>
                    </div>
                  </div>

                  {depots.length === 0 ? (
                    <div className="text-center py-12 bg-gray-50 rounded-lg">
                      <div className="text-5xl mb-4">üè¨</div>
                      <h3 className="text-xl font-bold mb-2">Depo Yok</h3>
                      <p className="text-gray-600 mb-4">Hen√ºz depo eklenmemi≈ü</p>
                      <div className="flex gap-3 justify-center">
                        <button 
                          onClick={createSampleDepot}
                          className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 font-semibold"
                        >
                          üîÑ √ñrnek Depo
                        </button>
                        <button 
                          onClick={() => { setDepotForm({ name: '', location: '', description: '' }); setSelectedDepot(null); setModal('depotForm'); }}
                          className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold"
                        >
                          + Manuel Ekle
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {depots.map(depot => {
                        const depotShelves = shelves.filter(s => s.depot_id === depot.id);
                        const productCount = products.filter(p => p.depot === depot.name).length;
                        
                        return (
                          <div key={depot.id} className="border-2 border-gray-200 rounded-xl overflow-hidden hover:border-orange-300 transition-all">
                            {/* Depo Header */}
                            <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white p-4">
                              <div className="flex justify-between items-start">
                                <div>
                                  <h3 className="font-bold text-lg flex items-center gap-2">
                                    <span>üè¨</span>
                                    {depot.name}
                                  </h3>
                                  {depot.location && <p className="text-sm opacity-90">üìç {depot.location}</p>}
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="bg-white/20 px-2 py-1 rounded text-sm">{productCount} √ºr√ºn</span>
                                  <span className="bg-white/20 px-2 py-1 rounded text-sm">{depotShelves.length} raf</span>
                                  <button 
                                    onClick={() => { 
                                      setSelectedDepot(depot); 
                                      setDepotForm({ name: depot.name, location: depot.location || '', description: depot.description || '' }); 
                                      setModal('depotForm'); 
                                    }}
                                    className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded"
                                  >
                                    ‚úèÔ∏è
                                  </button>
                                  <button 
                                    onClick={() => { 
                                      setSelectedDepot(depot); 
                                      setModal('confirmDeleteDepot'); 
                                    }}
                                    className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded"
                                  >
                                    üóëÔ∏è
                                  </button>
                                </div>
                              </div>
                            </div>
                            
                            {/* Raflar */}
                            <div className="p-4 bg-gray-50">
                              <div className="flex justify-between items-center mb-3">
                                <span className="font-semibold text-gray-700 text-sm">üì¶ Raflar</span>
                                <button 
                                  onClick={() => { 
                                    setShelfForm({ name: '', depot_id: depot.id, description: '' }); 
                                    setSelectedShelf(null); 
                                    setModal('shelfForm'); 
                                  }}
                                  className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm font-semibold"
                                >
                                  + Raf
                                </button>
                              </div>
                              
                              {depotShelves.length === 0 ? (
                                <p className="text-gray-500 text-sm text-center py-4">Bu depoda hen√ºz raf yok</p>
                              ) : (
                                <div className="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-2">
                                  {depotShelves.map(shelf => {
                                    const shelfProductCount = products.filter(p => p.shelf === shelf.name && p.depot === depot.name).length;
                                    return (
                                      <div key={shelf.id} className="bg-white border rounded-lg p-2 hover:border-green-400 transition-all">
                                        <div className="flex justify-between items-center mb-1">
                                          <span className="font-semibold text-sm">{shelf.name}</span>
                                          <span className="bg-green-100 text-green-800 text-xs px-1.5 py-0.5 rounded-full">{shelfProductCount}</span>
                                        </div>
                                        <div className="flex gap-1">
                                          <button 
                                            onClick={() => { 
                                              setSelectedShelf(shelf); 
                                              setShelfForm({ name: shelf.name, depot_id: depot.id, description: shelf.description || '' }); 
                                              setModal('shelfForm'); 
                                            }}
                                            className="flex-1 bg-orange-100 text-orange-700 py-0.5 rounded text-xs hover:bg-orange-200"
                                          >
                                            ‚úèÔ∏è
                                          </button>
                                          <button 
                                            onClick={() => { 
                                              setSelectedShelf(shelf); 
                                              setModal('confirmDeleteShelf'); 
                                            }}
                                            className="flex-1 bg-red-100 text-red-700 py-0.5 rounded text-xs hover:bg-red-200"
                                          >
                                            üóëÔ∏è
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Excel ƒ∞≈ülemleri */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4">üìä Excel ƒ∞≈ülemleri</h2>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-gradient-to-r from-green-500 to-teal-500 rounded-xl p-5 text-white">
                      <h4 className="font-semibold mb-2">üìÅ Toplu √úr√ºn Ekle</h4>
                      <p className="text-sm opacity-80 mb-3">Excel'den yeni √ºr√ºnler ekleyin (√úr√ºn Adƒ±, Barkod, Fiyat)</p>
                      <input ref={fileRef} type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" id="excelSettings" />
                      <label htmlFor="excelSettings" className="block bg-white text-green-600 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold cursor-pointer text-center">üìÅ Excel Se√ß</label>
                    </div>
                    <div className="bg-gradient-to-r from-teal-500 to-cyan-500 rounded-xl p-5 text-white">
                      <h4 className="font-semibold mb-2">üí∞ Fiyat G√ºncelle</h4>
                      <p className="text-sm opacity-80 mb-3">Barkod ile e≈üle≈üen fiyatlarƒ± g√ºncelle, olmayanƒ± ekle</p>
                      <input ref={priceFileRef} type="file" accept=".xlsx,.xls" onChange={handlePriceUpdate} className="hidden" id="priceExcelSettings" />
                      <label htmlFor="priceExcelSettings" className="block bg-white text-teal-600 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold cursor-pointer text-center">üí∞ Fiyat Excel Se√ß</label>
                    </div>
                    <div className="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl p-5 text-white">
                      <h4 className="font-semibold mb-2">üßπ Duplicate Temizle</h4>
                      <p className="text-sm opacity-80 mb-3">Aynƒ± barkod/isimli tekrar eden √ºr√ºnleri sil</p>
                      <button onClick={cleanDuplicateProducts} className="w-full bg-white text-orange-600 px-4 py-2 rounded-lg hover:bg-gray-100 font-semibold">üßπ Temizle</button>
                    </div>
                  </div>
                  <div className="mt-4 bg-gray-100 rounded-lg p-3">
                    <p className="text-sm text-gray-600">
                      <strong>Excel Format:</strong> Barkod, √úr√ºn Adƒ±, Fiyat, Min Stok s√ºtunlarƒ± olmalƒ±
                    </p>
                  </div>
                </div>
              </div>
            )}

            {page === 'entry' && (
              <div className="grid grid-cols-3 gap-6">
                <div className="col-span-2 space-y-6">
                  <div className="bg-white rounded-xl shadow-lg p-4">
                    <SearchBar value={search} onChange={setSearch} onSearch={() => performSearch(search)} onClear={() => { setSearch(''); setSearchResults([]); }} searching={searching} />
                  </div>
                  
                  <div className="bg-white rounded-xl shadow-lg p-4">
                    {searchResults.length > 0 ? (
                      <div className="grid grid-cols-4 gap-3 max-h-[500px] overflow-y-auto">
                        {searchResults.map(p => {
                          const entryItem = entryCart.find(c => c.id === p.id);
                          return (
                            <button key={p.id} onClick={() => addToEntryCart(p)} className="border rounded-xl p-3 text-left hover:shadow hover:border-green-400 transition-all">
                              <p className="font-semibold text-sm truncate">{p.name}</p>
                              <p className="text-green-600 font-bold">{formatCurrency(p.price)}</p>
                              <span className="text-xs text-gray-500">Mevcut: {p.current_stock} adet</span>
                              {entryItem && <span className="text-xs text-green-600 block font-semibold">üì• +{entryItem.quantity}</span>}
                            </button>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="text-center py-12">
                        <div className="flex justify-center mb-4 text-gray-400">
                          <DollyIcon size={80} />
                        </div>
                        <p>Stoƒüa eklemek i√ßin √ºr√ºn arayƒ±n</p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-4">
                  <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                    <DollyIcon size={24} color="#10b981" /> Giri≈ü Sepeti ({entryCart.length})
                  </h3>
                  
                  {/* Depo ve Raf Se√ßimi */}
                  <div className="space-y-3 mb-4 p-3 bg-green-50 rounded-lg border-2 border-green-200">
                    <div>
                      <label className="block text-sm font-semibold mb-1">üè¨ Depo *</label>
                      <select 
                        value={entryDepot} 
                        onChange={e => { setEntryDepot(e.target.value); setEntryShelf(''); }}
                        className="w-full px-3 py-2 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      >
                        <option value="">Depo Se√ß</option>
                        {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-1">üì¶ Raf *</label>
                      <select 
                        value={entryShelf} 
                        onChange={e => setEntryShelf(e.target.value)}
                        className="w-full px-3 py-2 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                        disabled={!entryDepot}
                      >
                        <option value="">Raf Se√ß</option>
                        {shelves.filter(s => {
                          const depot = depots.find(d => d.name === entryDepot);
                          return depot && s.depot_id === depot.id;
                        }).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                      </select>
                    </div>
                  </div>
                  
                  <div className="space-y-3 mb-4 max-h-64 overflow-y-auto">
                    {entryCart.length === 0 ? (
                      <div className="text-center py-8"><div className="text-4xl mb-4">üì≠</div><p>Giri≈ü sepeti bo≈ü</p></div>
                    ) : (
                      entryCart.map(item => (
                        <div key={item.id} className="border rounded-lg p-3 bg-green-50">
                          <div className="flex justify-between mb-2">
                            <p className="font-semibold text-sm">{item.name}</p>
                            <button onClick={() => updateEntryCartQty(item.id, 0)} className="text-red-600 hover:text-red-800">‚úï</button>
                          </div>
                          <div className="flex items-center gap-2">
                            <button onClick={() => updateEntryCartQty(item.id, item.quantity - 1)} className="bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">-</button>
                            <input 
                              type="number" 
                              value={item.quantity} 
                              onChange={(e) => updateEntryCartQty(item.id, parseInt(e.target.value) || 0)} 
                              className="w-16 px-2 py-1 border rounded text-center" 
                              min="1" 
                            />
                            <button onClick={() => updateEntryCartQty(item.id, item.quantity + 1)} className="bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">+</button>
                            <span className="text-sm text-gray-600">adet</span>
                          </div>
                        </div>
                      ))
                    )}
                  </div>

                  {entryCart.length > 0 && (
                    <div className="border-t pt-4 space-y-4">
                      <div className="bg-green-100 rounded-lg p-3">
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">Toplam Giri≈ü:</span>
                          <span className="text-2xl font-bold text-green-600">
                            {entryCart.reduce((sum, i) => sum + i.quantity, 0)} adet
                          </span>
                        </div>
                        <p className="text-sm text-gray-600 mt-1">{entryCart.length} farklƒ± √ºr√ºn</p>
                      </div>
                      <button 
                        onClick={completeEntry} 
                        disabled={!entryDepot || !entryShelf}
                        className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        ‚úÖ Stok Giri≈üini Tamamla
                      </button>
                      <button 
                        onClick={() => setEntryCart([])} 
                        className="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-semibold"
                      >
                        üóëÔ∏è Sepeti Temizle
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}

            {page === 'pos' && (
              <div className="grid grid-cols-3 gap-6">
                <div className="col-span-2 space-y-6">
                  <div className="bg-white rounded-xl shadow-lg p-4">
                    <SearchBar value={search} onChange={setSearch} onSearch={() => performSearch(search)} onClear={() => { setSearch(''); setSearchResults([]); }} searching={searching} />
                  </div>
                  <div className="bg-white rounded-xl shadow-lg p-4">
                    {searchResults.length > 0 ? (
                      <div className="grid grid-cols-4 gap-3 max-h-[500px] overflow-y-auto">
                        {searchResults.map(p => {
                          const cartItem = cart.find(c => c.id === p.id);
                          const availableStock = p.current_stock - (cartItem?.quantity || 0);
                          if (availableStock <= 0) return null;
                          return (
                            <button key={p.id} onClick={() => addToCart(p)} className="border rounded-xl p-3 text-left hover:shadow">
                              <p className="font-semibold text-sm truncate">{p.name}</p>
                              <p className="text-green-600 font-bold">{formatCurrency(p.price)}</p>
                              <span className="text-xs">{availableStock} adet</span>
                              {cartItem && <span className="text-xs text-blue-600 block">üõí {cartItem.quantity}</span>}
                            </button>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="text-center py-12">
                        <div className="text-5xl mb-4">üõí</div>
                        <p>√úr√ºn aramak i√ßin yukarƒ±ya yazƒ±n</p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-4">
                  <h3 className="text-xl font-bold mb-4">üõí Sepet ({cart.length})</h3>
                  <div className="space-y-3 mb-4 max-h-80 overflow-y-auto">
                    {cart.length === 0 ? (
                      <div className="text-center py-8"><div className="text-4xl mb-4">üì≠</div><p>Sepet bo≈ü</p></div>
                    ) : (
                      cart.map(item => (
                        <div key={item.id} className="border rounded-lg p-3">
                          <div className="flex justify-between mb-2">
                            <p className="font-semibold text-sm">{item.name}</p>
                            <button onClick={() => updateCartQty(item.id, 0)} className="text-red-600">‚úï</button>
                          </div>
                          <div className="flex items-center gap-2">
                            <input type="number" value={item.quantity} onChange={(e) => updateCartQty(item.id, parseInt(e.target.value) || 0)} className="w-16 px-2 py-1 border rounded text-center" min="1" max={item.current_stock} />
                            <span className="text-sm">√ó {formatCurrency(item.price)}</span>
                            <span className="text-xs text-gray-400">(stok: {item.current_stock})</span>
                          </div>
                          <p className="text-right font-bold text-green-600 mt-1">{formatCurrency(item.price * item.quantity)}</p>
                        </div>
                      ))
                    )}
                  </div>

                  {cart.length > 0 && (
                    <div className="border-t pt-4 space-y-4">
                      <div className="flex items-center gap-2">
                        <label className="text-sm font-semibold">ƒ∞ndirim %:</label>
                        <input type="number" value={discount} onChange={(e) => setDiscount(Math.min(100, Math.max(0, parseFloat(e.target.value) || 0)))} className="flex-1 px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between"><span>Ara Toplam:</span><span className="font-semibold">{formatCurrency(cartTotal)}</span></div>
                        {discount > 0 && <div className="flex justify-between text-red-600"><span>ƒ∞ndirim:</span><span>-{formatCurrency(cartTotal * discount / 100)}</span></div>}
                        <div className="flex justify-between font-bold text-lg border-t pt-2"><span>TOPLAM:</span><span className="text-green-600">{formatCurrency(cartFinal)}</span></div>
                      </div>
                      <button onClick={completeSale} className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold">‚úÖ Satƒ±≈üƒ± Tamamla</button>
                    </div>
                  )}
                </div>
              </div>
            )}

            {page === 'sales' && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-2xl font-bold mb-6">üìä Satƒ±≈ülar ({stats.totalSales})</h2>
                {sales.length === 0 ? (
                  <div className="text-center py-12"><div className="text-5xl mb-4">üí∞</div><h3 className="text-xl font-bold">Satƒ±≈ü Yok</h3></div>
                ) : (
                  <div className="space-y-4">
                    {sales.map(sale => (
                      <div key={sale.id} className="border-2 rounded-xl p-4">
                        <div className="flex justify-between mb-2">
                          <div>
                            <h3 className="font-bold">Satƒ±≈ü #{sale.id}</h3>
                            <p className="text-sm text-gray-600">{formatDate(sale.created_at)}</p>
                            <p className="text-sm text-blue-600 font-medium">üë§ {sale.profiles?.full_name || sale.profiles?.email || 'Bilinmiyor'}</p>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="font-bold text-lg text-green-600">{formatCurrency(sale.total_amount)}</span>
                            <button onClick={() => printSale(sale)} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-semibold">üñ®Ô∏è Yazdƒ±r</button>
                          </div>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3 space-y-1">
                          {sale.sale_items?.map((item, i) => (
                            <div key={i} className="flex justify-between text-sm">
                              <span>{item.products?.name} √ó {item.quantity}</span>
                              <span>{formatCurrency(item.total)}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {page === 'reports' && (
              <div className="space-y-6">
                <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                  <h1 className="text-2xl font-bold">üìà Raporlar & ƒ∞statistikler</h1>
                  <p>Satƒ±≈ü ve stok analizleri</p>
                </div>

                {/* √ñzet Kartlarƒ± */}
                <div className="grid grid-cols-4 gap-4">
                  <div className="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Toplam Satƒ±≈ü</p>
                    <p className="text-3xl font-bold mt-2">{formatCurrency(sales.reduce((sum, s) => sum + (s.total_amount || 0), 0))}</p>
                    <p className="text-sm opacity-80 mt-1">{sales.length} i≈ülem</p>
                  </div>
                  <div className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Toplam Stok</p>
                    <p className="text-3xl font-bold mt-2">{stats.totalStock} adet</p>
                    <p className="text-sm opacity-80 mt-1">{depots.length} depo</p>
                  </div>
                  <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Ortalama Satƒ±≈ü</p>
                    <p className="text-3xl font-bold mt-2">{formatCurrency(sales.length > 0 ? sales.reduce((sum, s) => sum + (s.total_amount || 0), 0) / sales.length : 0)}</p>
                    <p className="text-sm opacity-80 mt-1">i≈ülem ba≈üƒ±na</p>
                  </div>
                  <div className="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-6 shadow-lg">
                    <p className="text-sm opacity-80">Depolar</p>
                    <p className="text-3xl font-bold mt-2">{depots.length}</p>
                    <p className="text-sm opacity-80 mt-1">aktif depo</p>
                  </div>
                </div>

                {/* Son Satƒ±≈ülar Tablosu */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">üìÖ Son 10 Satƒ±≈ü</h3>
                  {sales.length === 0 ? (
                    <p className="text-gray-500 text-center py-8">Hen√ºz satƒ±≈ü yok</p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead>
                          <tr className="border-b-2">
                            <th className="text-left py-3 px-4">Fi≈ü No</th>
                            <th className="text-left py-3 px-4">Tarih</th>
                            <th className="text-left py-3 px-4">Satƒ±cƒ±</th>
                            <th className="text-left py-3 px-4">√úr√ºn Sayƒ±sƒ±</th>
                            <th className="text-right py-3 px-4">Tutar</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sales.slice(0, 10).map(sale => (
                            <tr key={sale.id} className="border-b hover:bg-gray-50">
                              <td className="py-3 px-4 font-semibold">#{sale.id}</td>
                              <td className="py-3 px-4 text-gray-600">{formatDate(sale.created_at)}</td>
                              <td className="py-3 px-4 text-blue-600">{sale.profiles?.full_name || sale.profiles?.email || '-'}</td>
                              <td className="py-3 px-4">{sale.sale_items?.length || 0} √ºr√ºn</td>
                              <td className="py-3 px-4 text-right font-bold text-green-600">{formatCurrency(sale.total_amount)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

                {/* D√º≈ü√ºk Stok Uyarƒ±larƒ± */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">‚ö†Ô∏è D√º≈ü√ºk Stok Uyarƒ±larƒ±</h3>
                  <p className="text-sm text-gray-600 mb-4">Minimum stok seviyesinin altƒ±ndaki √ºr√ºnler</p>
                  {products.filter(p => p.current_stock <= (p.min_stock || 10)).length === 0 ? (
                    <div className="text-center py-8">
                      <div className="text-5xl mb-4">‚úÖ</div>
                      <p className="text-green-600 font-semibold">T√ºm √ºr√ºnler yeterli stokta!</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {products.filter(p => p.current_stock <= (p.min_stock || 10)).slice(0, 9).map(p => (
                        <div key={p.id} className={`border-2 rounded-lg p-4 ${p.current_stock === 0 ? 'border-red-300 bg-red-50' : 'border-yellow-300 bg-yellow-50'}`}>
                          <div className="flex justify-between items-start">
                            <div>
                              <h4 className="font-semibold">{p.name}</h4>
                              <p className="text-sm text-gray-600">{p.barcode || 'Barkod yok'}</p>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${p.current_stock === 0 ? 'bg-red-500 text-white' : 'bg-yellow-500 text-white'}`}>
                              {p.current_stock} adet
                            </span>
                          </div>
                          <div className="mt-2 text-sm">
                            <span className="text-gray-600">Min: {p.min_stock || 10}</span>
                            <span className="mx-2">‚Ä¢</span>
                            <span className={p.current_stock === 0 ? 'text-red-600 font-bold' : 'text-yellow-600 font-bold'}>
                              {p.current_stock === 0 ? 'Stok T√ºkendi!' : 'D√º≈ü√ºk Stok'}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Depo Bazlƒ± Daƒüƒ±lƒ±m */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h3 className="text-xl font-bold mb-4">üè¨ Depo Bazlƒ± √úr√ºn Daƒüƒ±lƒ±mƒ±</h3>
                  {depots.length === 0 ? (
                    <p className="text-gray-500 text-center py-8">Hen√ºz depo yok</p>
                  ) : (
                    <div className="space-y-3">
                      {depots.map(depot => {
                        const count = products.filter(p => p.depot === depot.name).length;
                        const percentage = totalProducts > 0 ? (count / totalProducts * 100).toFixed(1) : 0;
                        return (
                          <div key={depot.id} className="flex items-center gap-4">
                            <div className="w-32 font-semibold truncate">{depot.name}</div>
                            <div className="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                              <div 
                                className="bg-gradient-to-r from-orange-500 to-red-500 h-full rounded-full flex items-center justify-end pr-2"
                                style={{ width: `${Math.max(percentage, 5)}%` }}
                              >
                                <span className="text-white text-xs font-bold">{count}</span>
                              </div>
                            </div>
                            <div className="w-16 text-right text-sm text-gray-600">{percentage}%</div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* MODALS */}
          {modal === 'printReceipt' && lastSale && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-center">‚úÖ Satƒ±≈ü Tamamlandƒ±!</h2>
                
                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4 text-center">
                  <p className="text-sm text-green-700 mb-1">Fi≈ü No: #{lastSale.id}</p>
                  <p className="text-sm text-green-700 mb-2">Kasiyer: {lastSale.user}</p>
                  <p className="text-3xl font-bold text-green-600">{formatCurrency(lastSale.total)}</p>
                </div>

                <div className="bg-gray-50 rounded-lg p-4 mb-4">
                  <div className="space-y-2 text-sm">
                    {lastSale.items.map((item, i) => (
                      <div key={i} className="flex justify-between">
                        <span>{item.name} √ó {item.quantity}</span>
                        <span className="font-semibold">{formatCurrency(item.price * item.quantity)}</span>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div className="flex gap-3">
                  <button onClick={() => { printReceipt(); setModal(''); }} className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-bold">üñ®Ô∏è Yazdƒ±r</button>
                  <button onClick={() => setModal('')} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300 font-semibold">Kapat</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'stockConfirm' && selected && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">üì¶ Stok ƒ∞≈ülemi</h2>
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                  <h3 className="font-bold text-lg">{selected.name}</h3>
                  <p className="text-gray-600 mt-2">Mevcut stok: <strong>{selected.current_stock}</strong> adet</p>
                </div>
                
                {(!selected.depot || !selected.shelf) ? (
                  <div className="space-y-4 mb-4">
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3">
                      <p className="text-yellow-800 font-semibold">‚ö†Ô∏è Depo/Raf bilgisi eksik!</p>
                      <p className="text-sm text-yellow-700">A≈üaƒüƒ±dan se√ßim yapƒ±n:</p>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block font-semibold mb-2">Depo *</label>
                        <select 
                          value={stockMovement.depot || ''} 
                          onChange={e => setStockMovement({...stockMovement, depot: e.target.value, shelf: ''})}
                          className="w-full px-3 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                        >
                          <option value="">Depo Se√ß</option>
                          {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block font-semibold mb-2">Raf *</label>
                        <select 
                          value={stockMovement.shelf || ''} 
                          onChange={e => setStockMovement({...stockMovement, shelf: e.target.value})}
                          className="w-full px-3 py-2 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                          disabled={!stockMovement.depot}
                        >
                          <option value="">Raf Se√ß</option>
                          {shelves.filter(s => {
                            const depot = depots.find(d => d.name === stockMovement.depot);
                            return depot && s.depot_id === depot.id;
                          }).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                        </select>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="mb-4">
                    <p className="text-gray-600">Bu √ºr√ºn ≈üu konumda kayƒ±tlƒ±:</p>
                    <p className="text-xl font-bold text-blue-600 mt-1">
                      üè¨ {selected.depot} / üì¶ {selected.shelf}
                    </p>
                    <p className="text-gray-700 mt-3">Bu konuma stok eklemek veya √ßƒ±karmak istiyor musunuz?</p>
                  </div>
                )}
                
                <div className="flex gap-3">
                  <button 
                    onClick={async () => {
                      // Depo/raf eksikse √∂nce g√ºncelle
                      if (!selected.depot || !selected.shelf) {
                        if (!stockMovement.depot || !stockMovement.shelf) {
                          showToast('Depo ve raf se√ßin', 'warning');
                          return;
                        }
                        // √úr√ºn√º g√ºncelle
                        await supabase.from('products').update({ 
                          depot: stockMovement.depot, 
                          shelf: stockMovement.shelf 
                        }).eq('id', selected.id);
                        // Selected'ƒ± g√ºncelle
                        setSelected({...selected, depot: stockMovement.depot, shelf: stockMovement.shelf});
                        showToast('Depo/raf atandƒ±', 'success');
                      }
                      setModal('stock');
                    }} 
                    disabled={!selected.depot && !selected.shelf && (!stockMovement.depot || !stockMovement.shelf)}
                    className={`flex-1 py-3 rounded-lg font-bold ${
                      (!selected.depot || !selected.shelf) && (!stockMovement.depot || !stockMovement.shelf)
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-green-500 text-white hover:bg-green-600'
                    }`}
                  >
                    ‚úÖ Devam Et
                  </button>
                  <button onClick={() => { setModal(''); setSelected(null); setStockMovement({ quantity: 0, type: 'in', depot: '', shelf: '' }); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300 font-semibold">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'stock' && selected && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">üì¶ Stok ƒ∞≈ülemi</h2>
                <div className="bg-gray-50 rounded-lg p-4 mb-4">
                  <h3 className="font-bold text-lg">{selected.name}</h3>
                  <p className="text-gray-600">Mevcut: <strong className="text-xl">{selected.current_stock}</strong> adet</p>
                  <p className="text-sm text-blue-600 font-semibold mt-1">üìç {selected.depot || 'Depo yok'} / {selected.shelf || 'Raf yok'}</p>
                </div>
                
                {(!selected.depot || !selected.shelf) && (
                  <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3 mb-4">
                    <p className="text-red-800 font-semibold">‚ùå Depo/Raf bilgisi eksik!</p>
                    <p className="text-sm text-red-700">√ñnce √ºr√ºn√º d√ºzenleyip depo ve raf atayƒ±n.</p>
                  </div>
                )}
                
                <div className="mb-4">
                  <label className="block font-semibold mb-2">ƒ∞≈ülem:</label>
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => setStockMovement({...stockMovement, type: 'in'})} className={`py-3 rounded-lg font-bold border-2 ${stockMovement.type === 'in' ? 'bg-green-500 text-white border-green-500' : 'bg-white text-green-600 border-green-500'}`}>üì• Giri≈ü</button>
                    <button onClick={() => setStockMovement({...stockMovement, type: 'out'})} className={`py-3 rounded-lg font-bold border-2 ${stockMovement.type === 'out' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-red-600 border-red-500'}`}>üì§ √áƒ±kƒ±≈ü</button>
                  </div>
                </div>
                <div className="mb-4">
                  <label className="block font-semibold mb-2">Miktar:</label>
                  <input 
                    type="text"
                    inputMode="numeric"
                    pattern="[0-9]*"
                    value={stockMovement.quantity || ''} 
                    onChange={e => {
                      const val = e.target.value.replace(/[^0-9]/g, '');
                      setStockMovement({...stockMovement, quantity: val ? parseInt(val) : 0});
                    }} 
                    className="w-full px-4 py-4 border-2 rounded-lg text-center text-3xl font-bold focus:border-blue-500 focus:outline-none" 
                    placeholder="0"
                    autoFocus 
                  />
                </div>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 mb-4 text-center">
                  <p className="text-sm text-gray-600">ƒ∞≈ülem Sonucu:</p>
                  <p className="text-2xl font-bold text-blue-600">
                    {stockMovement.type === 'in' 
                      ? selected.current_stock + (stockMovement.quantity || 0)
                      : Math.max(0, selected.current_stock - (stockMovement.quantity || 0))
                    } adet
                  </p>
                </div>
                
                <div className="flex gap-3">
                  <button 
                    onClick={applyStockMovement} 
                    disabled={!selected.depot || !selected.shelf}
                    className={`flex-1 py-3 rounded-lg font-bold ${
                      !selected.depot || !selected.shelf
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : stockMovement.type === 'in' 
                          ? 'bg-green-500 text-white hover:bg-green-600' 
                          : 'bg-red-500 text-white hover:bg-red-600'
                    }`}
                  >
                    {stockMovement.type === 'in' ? 'üì•' : 'üì§'} {stockMovement.quantity || 0} Adet {stockMovement.type === 'in' ? 'Ekle' : '√áƒ±kar'}
                  </button>
                  <button onClick={() => { setModal(''); setSelected(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300 font-semibold">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'productForm' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
              <div className="bg-white rounded-xl p-6 w-full max-w-lg my-8">
                <h2 className="text-2xl font-bold mb-4">{selected ? '‚úèÔ∏è √úr√ºn D√ºzenle' : '‚ûï Yeni √úr√ºn'}</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">√úr√ºn Adƒ± *</label>
                    <input type="text" value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="√úr√ºn adƒ± girin" autoFocus />
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Barkod</label>
                    <input type="text" value={productForm.barcode} onChange={e => setProductForm({...productForm, barcode: e.target.value})} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Barkod numarasƒ±" />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block font-semibold mb-2">Satƒ±≈ü Fiyatƒ± *</label>
                      <input type="number" value={productForm.price} onChange={e => setProductForm({...productForm, price: parseFloat(e.target.value) || 0})} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" min="0" step="0.01" />
                    </div>
                    <div>
                      <label className="block font-semibold mb-2">Min. Stok Uyarƒ±</label>
                      <input type="number" value={productForm.min_stock} onChange={e => setProductForm({...productForm, min_stock: e.target.value === '' ? 0 : parseInt(e.target.value)})} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" min="0" />
                    </div>
                  </div>
                </div>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 mt-4">
                  <p className="text-sm text-blue-800">üí° Stok eklemek i√ßin √ºr√ºn√º kaydettikten sonra "Stok Giri≈ü/√áƒ±kƒ±≈ü" butonunu kullanƒ±n.</p>
                </div>

                <div className="flex gap-3 mt-6">
                  <button onClick={saveProduct} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold">‚úÖ Kaydet</button>
                  <button onClick={() => { setModal(''); setSelected(null); setProductForm({ name: '', barcode: '', price: 0, min_stock: 10 }); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'confirmDelete' && selected && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-orange-600">üîª Stok Sƒ±fƒ±rla</h2>
                <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700">Bu √ºr√ºn√ºn stoƒüunu sƒ±fƒ±rlamak istediƒüinize emin misiniz?</p>
                  <p className="font-bold text-lg mt-2">{selected.name}</p>
                  <p className="text-sm text-gray-600">Mevcut Stok: {selected.current_stock} adet</p>
                </div>
                <p className="text-orange-600 text-sm mb-4">‚ÑπÔ∏è √úr√ºn silinmeyecek, sadece stok 0 olacak.</p>
                <div className="flex gap-3">
                  <button onClick={() => deleteProduct(selected)} className="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-bold">üîª Evet, Sƒ±fƒ±rla</button>
                  <button onClick={() => { setModal(''); setSelected(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'confirmDeleteSelected' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-orange-600">üîª Toplu Stok Sƒ±fƒ±rla</h2>
                <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700">Se√ßili t√ºm √ºr√ºnlerin stoƒüunu sƒ±fƒ±rlamak istediƒüinize emin misiniz?</p>
                  <p className="font-bold text-2xl mt-2 text-orange-600">{selectedProducts.length} √ºr√ºn</p>
                </div>
                <p className="text-orange-600 text-sm mb-4">‚ÑπÔ∏è √úr√ºnler silinmeyecek, sadece stoklarƒ± 0 olacak.</p>
                <div className="flex gap-3">
                  <button onClick={deleteSelectedProducts} className="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-bold">üîª Evet, Hepsini Sƒ±fƒ±rla</button>
                  <button onClick={() => setModal('')} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'confirmCleanDuplicates' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-yellow-600">üßπ Duplicate √úr√ºn Temizle</h2>
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700">Aynƒ± barkoda sahip duplicate √ºr√ºnler silinecek.</p>
                  <p className="text-sm text-gray-600 mt-2">Her barkod i√ßin en eski kayƒ±t tutulacak, diƒüerleri silinecektir.</p>
                </div>
                <p className="text-yellow-600 text-sm mb-4">‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!</p>
                <div className="flex gap-3">
                  <button onClick={async () => { await cleanDuplicateProducts(); setModal(''); }} className="flex-1 bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 font-bold">üßπ Evet, Temizle</button>
                  <button onClick={() => setModal('')} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'depotForm' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">{selectedDepot ? '‚úèÔ∏è Depo D√ºzenle' : '‚ûï Yeni Depo'}</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">Depo Adƒ± *</label>
                    <input 
                      type="text" 
                      value={depotForm.name} 
                      onChange={e => setDepotForm({...depotForm, name: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                      placeholder="√ñrn: Ana Depo"
                      autoFocus 
                    />
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Konum *</label>
                    <input 
                      type="text" 
                      value={depotForm.location} 
                      onChange={e => setDepotForm({...depotForm, location: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                      placeholder="√ñrn: Merkez, A Blok"
                    />
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">A√ßƒ±klama</label>
                    <textarea 
                      value={depotForm.description} 
                      onChange={e => setDepotForm({...depotForm, description: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                      placeholder="Depo a√ßƒ±klamasƒ± (opsiyonel)"
                      rows={3}
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button onClick={saveDepot} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold">‚úÖ Kaydet</button>
                  <button onClick={() => { setModal(''); setSelectedDepot(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'confirmDeleteDepot' && selectedDepot && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-red-600">üóëÔ∏è Depo Sil</h2>
                <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700">Bu depoyu silmek istediƒüinize emin misiniz?</p>
                  <p className="font-bold text-lg mt-2">{selectedDepot.name}</p>
                </div>
                <p className="text-red-600 text-sm mb-4">‚ö†Ô∏è Depodaki t√ºm raflar da silinecek! Depoda √ºr√ºn varsa silinemez!</p>
                <div className="flex gap-3">
                  <button onClick={deleteDepot} className="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-bold">üóëÔ∏è Evet, Sil</button>
                  <button onClick={() => { setModal(''); setSelectedDepot(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'shelfForm' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">{selectedShelf ? '‚úèÔ∏è Raf D√ºzenle' : '‚ûï Yeni Raf'}</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">Raf Adƒ± *</label>
                    <input 
                      type="text" 
                      value={shelfForm.name} 
                      onChange={e => setShelfForm({...shelfForm, name: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                      placeholder="√ñrn: A-1, Raf-01"
                      autoFocus 
                    />
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">A√ßƒ±klama</label>
                    <input 
                      type="text" 
                      value={shelfForm.description} 
                      onChange={e => setShelfForm({...shelfForm, description: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                      placeholder="√ñrn: Sol koridor, alt raf"
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button onClick={saveShelf} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold">‚úÖ Kaydet</button>
                  <button onClick={() => { setModal(''); setSelectedShelf(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'confirmDeleteShelf' && selectedShelf && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-red-600">üóëÔ∏è Raf Sil</h2>
                <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                  <p className="text-gray-700">Bu rafƒ± silmek istediƒüinize emin misiniz?</p>
                  <p className="font-bold text-lg mt-2">üì¶ {selectedShelf.name}</p>
                  {selectedShelf.description && <p className="text-sm text-gray-600">{selectedShelf.description}</p>}
                </div>
                <p className="text-red-600 text-sm mb-4">‚ö†Ô∏è Rafta √ºr√ºn varsa silinemez!</p>
                <div className="flex gap-3">
                  <button onClick={deleteShelf} className="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-bold">üóëÔ∏è Evet, Sil</button>
                  <button onClick={() => { setModal(''); setSelectedShelf(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'transfer' && selected && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">üöö √úr√ºn Ta≈üƒ±</h2>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                  <p className="font-bold text-lg">{selected.name}</p>
                  <p className="text-sm text-gray-600">
                    Mevcut: {selected.depot || 'Belirtilmemi≈ü'} {selected.shelf ? `/ ${selected.shelf}` : ''}
                  </p>
                  <p className="text-sm font-semibold text-blue-600 mt-1">Ta≈üƒ±nacak Stok: {selected.current_stock} adet</p>
                </div>
                
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 mb-4">
                  <p className="text-sm text-yellow-800">
                    ‚ö†Ô∏è T√ºm stok ({selected.current_stock} adet) hedef konuma ta≈üƒ±nacaktƒ±r.
                  </p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">Hedef Depo *</label>
                    <select 
                      value={transferForm.depot} 
                      onChange={e => setTransferForm({...transferForm, depot: e.target.value, shelf: ''})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Depo Se√ß</option>
                      {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Hedef Raf *</label>
                    <select 
                      value={transferForm.shelf} 
                      onChange={e => setTransferForm({...transferForm, shelf: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                      disabled={!transferForm.depot}
                    >
                      <option value="">Raf Se√ß</option>
                      {shelves.filter(s => {
                        const depot = depots.find(d => d.name === transferForm.depot);
                        return depot && s.depot_id === depot.id;
                      }).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button onClick={transferProduct} className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-bold">üöö T√ºm√ºn√º Ta≈üƒ±</button>
                  <button onClick={() => { setModal(''); setSelected(null); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {/* Toplu Stok Ekleme Modalƒ± */}
          {modal === 'bulkStock' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">üì¶ Toplu Stok Ekle</h2>
                
                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                  <p className="font-bold text-2xl text-green-600">{selectedProducts.length} √ºr√ºn</p>
                  <p className="text-sm text-gray-600">se√ßili √ºr√ºne stok eklenecek</p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">Depo *</label>
                    <select 
                      value={bulkStockForm.depot} 
                      onChange={e => setBulkStockForm({...bulkStockForm, depot: e.target.value, shelf: ''})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Depo Se√ß</option>
                      {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Raf *</label>
                    <select 
                      value={bulkStockForm.shelf} 
                      onChange={e => setBulkStockForm({...bulkStockForm, shelf: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                      disabled={!bulkStockForm.depot}
                    >
                      <option value="">Raf Se√ß</option>
                      {shelves.filter(s => {
                        const depot = depots.find(d => d.name === bulkStockForm.depot);
                        return depot && s.depot_id === depot.id;
                      }).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Her √úr√ºne Eklenecek Miktar *</label>
                    <input 
                      type="number" 
                      value={bulkStockForm.quantity || ''} 
                      onChange={e => setBulkStockForm({...bulkStockForm, quantity: parseInt(e.target.value) || 0})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                      min="1"
                      placeholder="Miktar girin"
                    />
                  </div>
                </div>
                
                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 mt-4">
                  <p className="text-sm text-yellow-800">
                    ‚ö†Ô∏è Her bir √ºr√ºne <strong>{bulkStockForm.quantity || 0}</strong> adet stok eklenecek.
                    <br />Toplam: <strong>{selectedProducts.length * (bulkStockForm.quantity || 0)}</strong> adet
                  </p>
                </div>

                <div className="flex gap-3 mt-6">
                  <button 
                    onClick={applyBulkStock}
                    disabled={!bulkStockForm.depot || !bulkStockForm.shelf || !bulkStockForm.quantity}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold disabled:opacity-50"
                  >
                    ‚úÖ Stok Ekle
                  </button>
                  <button onClick={() => setModal('')} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}

          {modal === 'transferSelected' && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4">üöö Toplu √úr√ºn Ta≈üƒ±</h2>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                  <p className="font-bold text-2xl text-blue-600">{selectedProducts.length} √ºr√ºn</p>
                  <p className="text-sm text-gray-600">se√ßili √ºr√ºn ta≈üƒ±nacak</p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block font-semibold mb-2">Hedef Depo *</label>
                    <select 
                      value={transferForm.depot} 
                      onChange={e => setTransferForm({...transferForm, depot: e.target.value, shelf: ''})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Depo Se√ß</option>
                      {depots.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block font-semibold mb-2">Hedef Raf *</label>
                    <select 
                      value={transferForm.shelf} 
                      onChange={e => setTransferForm({...transferForm, shelf: e.target.value})} 
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none"
                      disabled={!transferForm.depot}
                    >
                      <option value="">Raf Se√ß (Opsiyonel)</option>
                      {shelves.filter(s => {
                        const depot = depots.find(d => d.name === transferForm.depot);
                        return depot && s.depot_id === depot.id;
                      }).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                    </select>
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button onClick={transferSelectedProducts} className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-bold">üöö T√ºm√ºn√º Ta≈üƒ±</button>
                  <button onClick={() => { setModal(''); setTransferForm({ depot: '', shelf: '', quantity: 0 }); }} className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300">ƒ∞ptal</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
